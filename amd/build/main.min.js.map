{"version":3,"sources":["../src/main.js"],"names":["define","$","Templates","Strings","Ally","ImageCover","Util","self","canViewFeedback","canDownload","initialised","params","getNodesByXpath","xpath","expression","window","document","createExpression","result","evaluate","XPathResult","ANY_TYPE","nodes","node","iterateNext","push","getNodeByXpath","FIRST_ORDERED_NODE_TYPE","singleNodeValue","renderTemplate","data","pathHash","targetEl","dfd","Deferred","parents","length","resolve","promise","canviewfeedback","candownload","html","render","done","presentWrappers","next","find","after","remove","placeHoldSelector","selector","map","c","each","checkComplete","url","type","prop","toLowerCase","attr","regex","indexOf","match","path","decodeURIComponent","query","getQuery","file","filePath","isimage","fileid","placeHoldForumModule","forumFileMapping","placeHoldAssignModule","assignFileMapping","whenTrue","placeHoldFolderModule","folderFileMapping","placeHoldGlossaryModule","glossaryFileMapping","mainAnchor","prev","addClass","iconAnchor","container","append","urlEncodeFilePath","parts","split","p","encodeURIComponent","encoded","join","placeHoldLessonGeneral","selectorPrefix","placeHoldLessonPageContents","pageContentsMap","placeHoldLessonAnswersContent","pageAnswersMap","placeHoldLessonResponsesContent","pageResponsesMap","placeHoldLessonModule","lessonFileMapping","page_contents","page_answers","page_responses","then","placeHoldResourceModule","moduleFileMapping","checkAllProcessed","Object","keys","moduleId","hasClass","moduleEl","processed","buildContentIdent","component","table","field","id","annotateSections","sectionMapping","s","sectionId","ident","annotateModuleIntros","introMapping","module","additionalSelectors","i","annotation","selectors","a","replace","annotateForums","forumMapping","intros","discussions","d","postSelector","prepend","detach","appendTo","annotateMRForums","annotateGlossary","mapping","entries","e","entryFooter","entry","annotatePage","content","annotateBook","chapterId","chapterid","urlParams","URLSearchParams","location","search","get","ch","annotateLesson","body","pageId","val","get_strings","key","strings","answerLabel","responseLabel","answers","processAnswerResponse","label","n","tmpArr","ansId","anum","answerid","answerEl","contentEls","nextAll","parent","responses","r","respId","rnum","responseWrapperId","annotateModules","moduleMapping","annotateSnapCourseSummary","snapFooterCourseSummary","courseId","annotateHtmlBlock","items","block_html","applyPlaceHolders","M","util","js_pending","ally_module_maps","ally_section_maps","tasks","mapVar","file_resources","method","assignment_files","folder_files","forum_files","glossary_files","lesson_files","ally_annotation_maps","ready","completed","onTaskComplete","js_complete","t","task","debounceApplyPlaceHolders","debounce","initStageTwo","jwt","config","init","targetNode","callback","mutationsList","filter","mutation","forEach","observer","MutationObserver","observe","attributes","childList","subtree","error","setInterval","ajaxComplete","pluginJSURL","cfg","wwwroot","contextid","polyfills","require","enforceDefine","paths","requires","arguments"],"mappings":"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","sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * Main library.\n *\n * @package   filter_ally\n * @author    Guy Thomas <osdev@blackboard.com>\n * @copyright Copyright (c) 2016 Blackboard Inc.\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n\ndefine(['jquery', 'core/templates', 'core/str', 'filter_ally/ally', 'filter_ally/imagecover', 'filter_ally/util'],\nfunction($, Templates, Strings, Ally, ImageCover, Util) {\n    return new function() {\n\n        var self = this;\n\n        self.canViewFeedback = false;\n        self.canDownload = false;\n        self.initialised = false;\n        self.params = {};\n\n        /**\n         * Get nodes by xpath.\n         * @param xpath\n         * @returns {Array}\n         */\n        var getNodesByXpath = function(xpath) {\n            var expression = window.document.createExpression(xpath);\n            var result = expression.evaluate(window.document, XPathResult.ANY_TYPE);\n            var nodes = [];\n            do {\n                var node = result.iterateNext();\n                nodes.push(node);\n            } while (node);\n            return nodes;\n        };\n\n        /**\n         * Get single node by xpath.\n         * @param xpath\n         * @returns {Node}\n         */\n        var getNodeByXpath = function(xpath) {\n            var expression = window.document.createExpression(xpath);\n            var result = expression.evaluate(window.document, XPathResult.FIRST_ORDERED_NODE_TYPE);\n            return result.singleNodeValue;\n        };\n\n        /**\n         * Render template and insert result in appropriate place.\n         * @return {promise}\n         */\n        var renderTemplate = function(data, pathHash, targetEl) {\n            var dfd = $.Deferred();\n\n            if ($(targetEl).parents('.filter-ally-wrapper').length) {\n                // This has already been processed.\n                dfd.resolve();\n                return dfd.promise();\n            }\n\n            // Too expensive to do at module level - this is a course level capability.\n            data.canviewfeedback = self.canViewFeedback;\n            data.candownload = self.canDownload;\n            data.html = '<span id=\"content-target-' + pathHash + '\"></span>';\n\n            Templates.render('filter_ally/wrapper', data)\n                .done(function(result) {\n                    var presentWrappers = $(targetEl).next().find('span[data-file-id=\"'+ pathHash +'\"]');\n                    if (presentWrappers.length == 0) {\n                        $(targetEl).after(result);\n\n                        // We are inserting the module element next to the target as opposed to replacing the\n                        // target as we want to ensure any listeners attributed to the module element persist.\n                        $('#content-target-' + pathHash).after(targetEl);\n                        $('#content-target-' + pathHash).remove();\n                    }\n                    dfd.resolve();\n                });\n\n            return dfd.promise();\n        };\n\n        /**\n         * Place holder items that are matched by selector.\n         * @param {string} selector\n         * @param {string} map\n         * @return {promise}\n         */\n        var placeHoldSelector = function(selector, map) {\n            var dfd = $.Deferred();\n\n            var c = 0;\n\n            var length = $(selector).length;\n            if (!length) {\n                dfd.resolve();\n            }\n            $(selector).each(function() {\n\n                /**\n                 * Check that all selectors have been processed.\n                 */\n                var checkComplete = function() {\n                    if (c === length) {\n                        dfd.resolve();\n                    }\n                };\n                var url,\n                    type;\n\n                if ($(this).prop(\"tagName\").toLowerCase() === 'a') {\n                    url = $(this).attr('href');\n                    type = 'a';\n                } else {\n                    url = $(this).attr('src');\n                    type = 'img';\n                }\n                var regex;\n                if (url.indexOf('?') > -1) {\n                    regex = /pluginfile.php\\/(\\d*)\\/(.*)(\\?)/;\n                } else {\n                    regex = /pluginfile.php\\/(\\d*)\\/(.*)/;\n                }\n                var match = url.match(regex);\n                var pathHash;\n                if (match) {\n                    var path = match[1] + '/' + match[2];\n                    path = decodeURIComponent(path);\n                    pathHash = map[path];\n                }\n\n                if (pathHash === undefined) {\n                    // Maybe 'slasharguments' setting is disabled for this host.\n                    // Let's see if the file URI is found in the URL query.\n                    var query = Util.getQuery(url);\n                    if (query.file) {\n                        var filePath = decodeURIComponent(query.file);\n                        regex = /\\/(\\d*)\\/(.*)/;\n\n                        match = filePath.match(regex);\n                        if (match) {\n                            path = match[1] + '/' + match[2];\n                            path = decodeURIComponent(path);\n                            pathHash = map[path];\n                        }\n                    }\n                }\n\n                // Pathhash was definitely not found :( .\n                if (pathHash === undefined) {\n                    c++;\n                    checkComplete();\n                    return;\n                }\n\n                var data = {\n                    isimage: type === 'img',\n                    fileid: pathHash,\n                    url: url\n                };\n\n                renderTemplate(data, pathHash, $(this))\n                    .done(function(){\n                        c++;\n                        checkComplete();\n                    });\n            });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for forum module image attachments (note, regular files are covered by php).\n         * @param {array}\n         * @return {promise}\n         */\n        var placeHoldForumModule = function(forumFileMapping) {\n            var dfd = $.Deferred();\n            placeHoldSelector('.forumpost .attachedimages img[src*=\"pluginfile.php\"]', forumFileMapping)\n                .done(function(){\n                    dfd.resolve();\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for assign module additional files.\n         * @param {array}\n         * @return {promise}\n         */\n        var placeHoldAssignModule = function(assignFileMapping) {\n            var dfd = $.Deferred();\n            Util.whenTrue(function() {\n                return $('div[id*=\"assign_files_tree\"] .ygtvitem').length > 0;\n            }, 10)\n                .done(function() {\n                    placeHoldSelector('div[id*=\"assign_files_tree\"] a[href*=\"pluginfile.php\"]', assignFileMapping);\n                    dfd.resolve();\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for folder module files.\n         * @param {array}\n         * @return {promise}\n         */\n        var placeHoldFolderModule = function(folderFileMapping) {\n            var dfd = $.Deferred();\n            Util.whenTrue(function() {\n                return $('.foldertree > .filemanager .ygtvitem').length > 0;\n            }, 10)\n                .done(function() {\n                    var unwrappedlinks = '.foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*=\"pluginfile.php\"]';\n                    placeHoldSelector(unwrappedlinks, folderFileMapping)\n                        .done(function() {\n                            dfd.resolve();\n                        });\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for glossary module files.\n         * @param {array}\n         * @return {promise}\n         */\n        var placeHoldGlossaryModule = function(glossaryFileMapping) {\n            var dfd = $.Deferred();\n\n            // Glossary attachment markup is terrible!\n            // The first thing we need to do is rewrite the glossary attachments so that they are encapsulated.\n            $('.entry .attachments > br').each(function() {\n                var mainAnchor = $(this).prev('a[href*=\"pluginfile.php\"]');\n                mainAnchor.addClass('ally-glossary-attachment');\n                var iconAnchor = $(mainAnchor).prev('a[href*=\"pluginfile.php\"]');\n                $(this).after('<div class=\"ally-glossary-attachment-row\"></div>');\n                var container = $(this).next('.ally-glossary-attachment-row');\n                container.append(iconAnchor);\n                container.append(mainAnchor);\n                $(this).remove();\n            });\n\n            var unwrappedlinks = '.entry .attachments .ally-glossary-attachment';\n            placeHoldSelector(unwrappedlinks, glossaryFileMapping)\n                .done(function() {\n                    dfd.resolve();\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Encode a file path so that it can be used to find things by uri.\n         * @param filePath\n         * @returns {string}\n         */\n        var urlEncodeFilePath = function(filePath) {\n            var parts = filePath.split('/');\n            for (var p in parts) {\n                parts[p] = encodeURIComponent(parts[p]);\n            }\n            var encoded = parts.join('/');\n            return encoded;\n        };\n\n        /**\n         * General function for finding lesson component file elements and then add mapping.\n         * @param array map\n         * @param string selectorPrefix\n         * @return promise\n         */\n        var placeHoldLessonGeneral = function(map, selectorPrefix) {\n            var dfd = $.Deferred();\n            if (map.length === 0) {\n                dfd.resolve();\n            } else {\n                for (var c in map) {\n                    var path = urlEncodeFilePath(c);\n                    var sel = selectorPrefix + 'img[src*=\"' + path + '\"], ' + selectorPrefix + 'a[href*=\"' + path + '\"]';\n                    placeHoldSelector(sel, map).done(function() {\n                        dfd.resolve();\n                    });\n                }\n            }\n            return dfd.promise();\n        };\n\n        /**\n         * Placehold lesson page contents.\n         * @param array pageContentsMap\n         * @returns promise\n         */\n        var placeHoldLessonPageContents = function(pageContentsMap) {\n            return placeHoldLessonGeneral(pageContentsMap, '');\n        };\n\n        /**\n         * Placehold lesson answers.\n         * @param array pageContentsMap\n         * @returns promise\n         */\n        var placeHoldLessonAnswersContent = function(pageAnswersMap) {\n            return placeHoldLessonGeneral(pageAnswersMap,\n                '.studentanswer table tr:nth-child(1) '); // Space at end of selector intended.\n        };\n\n        /**\n         * Placehold lesson responses.\n         * @param array pageResponsesMap\n         * @returns promise\n         */\n        var placeHoldLessonResponsesContent = function(pageResponsesMap) {\n            return placeHoldLessonGeneral(pageResponsesMap,\n                '.studentanswer table tr.lastrow '); // Space at end of selector intended.\n        };\n\n        /**\n         * Add place holders for lesson module files.\n         * @param {array}\n         * @return {promise}\n         */\n        var placeHoldLessonModule = function(lessonFileMapping) {\n            var dfd = $.Deferred();\n\n            var pageContentsMap = lessonFileMapping.page_contents;\n            var pageAnswersMap = lessonFileMapping.page_answers;\n            var pageResponsesMap = lessonFileMapping.page_responses;\n\n            placeHoldLessonPageContents(pageContentsMap)\n                .then(function() {\n                    return placeHoldLessonAnswersContent(pageAnswersMap);\n                })\n                .then(function() {\n                    return placeHoldLessonResponsesContent(pageResponsesMap);\n                })\n                .then(function() {\n                    dfd.resolve();\n                });\n            return dfd.promise();\n        };\n\n        /**\n         * Add place holders for resource module.\n         * @param moduleFileMapping\n         * @return {promise}\n         */\n        var placeHoldResourceModule = function(moduleFileMapping) {\n            var dfd = $.Deferred();\n            var c = 0;\n\n            /**\n             * Once all modules processed, resolve promise for this function.\n             */\n            var checkAllProcessed = function() {\n                c++;\n                // All resource modules have been dealt with.\n                if (c >= Object.keys(moduleFileMapping).length) {\n                    dfd.resolve();\n                }\n            };\n\n            for (var moduleId in moduleFileMapping) {\n                var pathHash = moduleFileMapping[moduleId]['content'];\n                if ($('body').hasClass('theme-snap')) {\n                    var moduleEl = $('#module-' + moduleId + ':not(.snap-native) .activityinstance ' +\n                        '.snap-asset-link a:first-of-type');\n                } else {\n                    var moduleEl = $('#module-' + moduleId + ' .activityinstance a:first-of-type');\n                }\n                var processed = moduleEl.find('.filter-ally-wrapper');\n                if (processed.length > 0) {\n                    checkAllProcessed(); // Already processed.\n                    continue;\n                }\n                var data = {\n                    isimage: false,\n                    fileid: pathHash,\n                    url: $(moduleEl).attr('href')\n                };\n                renderTemplate(data, pathHash, moduleEl)\n                    .done(checkAllProcessed);\n            }\n            return dfd.promise();\n        };\n\n        var buildContentIdent = function(component, table, field, id) {\n            return [component, table, field, id].join(':');\n        };\n\n        /**\n         * Add annotations to sections content.\n         */\n        var annotateSections = function(sectionMapping) {\n            var dfd = $.Deferred();\n\n            for (var s in sectionMapping) {\n                var sectionId = sectionMapping[s];\n                var ident = buildContentIdent('course', 'course_sections', 'summary', sectionId);\n\n                var selectors = [\n                    '#' + s + ' > .content div[class*=\"summary\"] > .no-overflow',\n                    'body.theme-snap #' + s + ' > .content > .summary > div > .no-overflow' // Snap.\n                ];\n\n                $(selectors.join(',')).attr('data-ally-richcontent', ident);\n            }\n\n            dfd.resolve();\n            return dfd.promise();\n        };\n\n        /**\n         * Annotate module introductions.\n         * @param array introMapping\n         * @param string\n         * @param array additionalSelectors\n         */\n        var annotateModuleIntros = function(introMapping, module, additionalSelectors) {\n            for (var i in introMapping) {\n                var annotation = introMapping[i];\n                var selectors = [\n                    'body.path-mod-' + module + '.cmid-' + i + ' #intro > .no-overflow',\n                    // We need to be specific here for non course pages to skip this.\n                    'li.activity.modtype_' + module + '#module-' + i + ' .contentafterlink > .no-overflow > .no-overflow',\n                    'li.snap-activity.modtype_' + module + '#module-' + i + ' .contentafterlink > .no-overflow'\n                ];\n                if (additionalSelectors) {\n                    for (var a in additionalSelectors) {\n                        selectors.push(additionalSelectors[a].replace('{{i}}', i));\n                    }\n                }\n                $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to forums.\n         * @param array forumMapping.\n         */\n        var annotateForums = function(forumMapping) {\n\n            // Annotate introductions.\n            var intros = forumMapping['intros'];\n            annotateModuleIntros(intros, 'forum');\n\n            // Annotate discussions.\n            var discussions = forumMapping['posts'];\n            for (var d in discussions) {\n                var post = 'p' + d;\n                var annotation = discussions[d];\n                var postSelector = \"#page-mod-forum-discuss a#\" + post +\n                    ' + div.firstpost div.posting.fullpost';\n                var contentSelector = postSelector + ' > *:not(.attachedimages):not([data-ally-richcontent])';\n                $(postSelector).prepend(\"<div data-ally-richcontent='\" + annotation + \"'></div>\");\n                $(contentSelector).detach().appendTo(postSelector + ' > div[data-ally-richcontent]');\n            }\n        };\n\n        /**\n         * Add annotations to Open Forums.\n         * @param array forumMapping\n         */\n        var annotateMRForums = function(forumMapping) {\n\n            // Annotate introductions.\n            var intros = forumMapping['intros'];\n            annotateModuleIntros(intros, 'hsuforum', ['#hsuforum-header .hsuforum_introduction > .no-overflow']);\n\n            var discussions = forumMapping['posts'];\n            for (var d in discussions) {\n                var annotation = discussions[d];\n                var postSelector = 'article[id=\"p' + d + '\"] div.posting';\n                $(postSelector).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to glossary.\n         * @param array mapping\n         */\n        var annotateGlossary = function(mapping) {\n            // Annotate introductions.\n            var intros = mapping['intros'];\n            annotateModuleIntros(intros, 'glossary');\n\n            // Annotate entries.\n            var entries = mapping['entries'];\n            for (var e in entries) {\n                var annotation = entries[e];\n                var entryFooter = $('.entrylowersection .commands a[href*=\"id=' + e + '\"]');\n                var entry = $(entryFooter).parents('.glossarypost').find('.entry .no-overflow');\n                $(entry).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to page.\n         * @param array mapping\n         */\n        var annotatePage = function(mapping) {\n            var intros = mapping['intros'];\n            annotateModuleIntros(intros, 'page', ['li.snap-native.modtype_page#module-{{i}} .contentafterlink > .summary-text']);\n\n            // Annotate content.\n            var content = mapping['content'];\n            for (var c in content) {\n                var annotation = content[c];\n                var selectors = [\n                    '#page-mod-page-view #region-main .box.generalbox > .no-overflow',\n                    'li.snap-native.modtype_page#module-' + c + ' .pagemod-content'\n                ];\n                $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n            }\n        };\n\n        /**\n         * Add annotations to book.\n         * @param {array} mapping\n         */\n        var annotateBook = function(mapping) {\n            var intros = mapping['intros'];\n\n            // For book, the only place the intro shows is on the course page when you select \"display description on course page\"\n            // in the module settings.\n            annotateModuleIntros(intros, 'book',\n                ['li.snap-native.modtype_book#module-{{i}} .contentafterlink > .summary-text .no-overflow']);\n\n            // Annotate content.\n            var content = mapping['chapters'], chapterId;\n\n            if (self.params.chapterid) {\n                chapterId = self.params.chapterid;\n            } else {\n                var urlParams = new URLSearchParams(window.location.search);\n                chapterId = urlParams.get('chapterid');\n            }\n\n            $.each(content, function(ch, annotation) {\n                if (chapterId != ch) {\n                    return;\n                }\n                var selectors = [\n                    '#page-mod-book-view #region-main .box.generalbox.book_content > .no-overflow',\n                    'li.snap-native.modtype_page#module-' + ch + ' .pagemod-content'\n                ];\n                $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n            });\n        };\n\n        /**\n         * Add annotations to lesson.\n         * @param array mapping\n         */\n        var annotateLesson = function(mapping) {\n            var intros = mapping['intros'];\n\n            // For lesson, the only place the intro shows is on the course page when you select \"display description on course page\"\n            // in the module settings.\n            annotateModuleIntros(intros, 'lesson',\n                ['li.snap-native.modtype_lesson#module-{{i}} .contentafterlink > .summary-text .no-overflow']);\n\n            // Annotate content.\n            var content = mapping['lesson_pages'];\n            for (var p in content) {\n                if (document.body.id === \"page-mod-lesson-edit\") {\n                    var xpath = '//a[@id=\"lesson-' + p + '\"]//ancestor::table//tbody/tr/td/div[contains(@class, \"no-overflow\")]';\n                    var annotation = content[p];\n                    var node = getNodeByXpath(xpath);\n                    $(node).attr('data-ally-richcontent', annotation);\n                } else {\n                    // Try get page from form.\n                    var node = getNodeByXpath('//form[contains(@action, \"continue.php\")]//input[@name=\"pageid\"]');\n                    if (node) {\n                        var pageId = $(node).val();\n                    } else {\n                        var urlParams = new URLSearchParams(window.location.search);\n                        var pageId = urlParams.get('pageid');\n                    }\n\n                    if (pageId != p) {\n                        continue;\n                    }\n                    var annotation = content[p];\n                    var selectors = [\n                        // Regular page.\n                        '#page-mod-lesson-view #region-main .box.contents > .no-overflow',\n                        // Question page.\n                        '#page-mod-lesson-view #region-main form > fieldset > .fcontainer > .contents .no-overflow',\n                        // Lesson page.\n                        'li.snap-native.modtype_page#module-' + p + ' .pagemod-content'\n                    ];\n\n                    $(selectors.join(',')).attr('data-ally-richcontent', annotation);\n                }\n            }\n\n            // Annotate answer answers.\n            Strings.get_strings([\n                {key:'answer', component:'mod_lesson'},\n                {key:'response', component:'mod_lesson'}\n            ]).then(function(strings) {\n                var answerLabel = strings[0];\n                var responseLabel = strings[1];\n                var answers = mapping['lesson_answers'];\n\n                var processAnswerResponse = function(pageId, i, label, annotation) {\n                    var xpath = '//a[@id=\"lesson-' + pageId + '\"]//ancestor::table' +\n                        '//td/label[contains(text(),\"' + label + ' ' + i + '\")]/ancestor::tr/td[2]';\n                    var nodes = getNodesByXpath(xpath);\n                    for (var n in nodes) {\n                        var node = nodes[n];\n                        $(node).attr('data-ally-richcontent', annotation);\n                    }\n                };\n\n                for (var a in answers) {\n                    // increment anum so that we can get the answer number.\n                    // Note, we can trust that this is correct because you can't order answers and the code in the lesson component\n                    // orders answers by id.\n                    var annotation = answers[a];\n\n                    var tmpArr = a.split('_');\n                    var pageId = tmpArr[0];\n                    var ansId = tmpArr[1];\n                    var anum = tmpArr[2];\n\n                    // Process answers when on lesson edit page.\n                    if (document.body.id === \"page-mod-lesson-edit\") {\n                        processAnswerResponse(pageId, anum, answerLabel, annotation);\n                    } else {\n                        // Wrap answers in labels.\n                        $('#page-mod-lesson-view label[for=\"id_answerid_' + ansId + '\"]').attr('data-ally-richcontent', annotation);\n\n                        if (self.params.answerid && self.params.answerid == ansId) {\n                            $('.studentanswer tr:nth-of-type(1) > td div').attr('data-ally-richcontent', annotation);\n                        } else {\n                            var answerWrapperId = 'answer_wrapper_' + ansId;\n                            var answerEl = $('#id_answerid_' + ansId);\n                            if (answerEl.data('annotated') != 1) {\n                                // We only want to wrap this once.\n                                var contentEls = answerEl.nextAll();\n                                answerEl.parent('label').append('<span id=\"answer_wrapper_' + ansId + '\"></span>');\n                                $('#' + answerWrapperId).append(contentEls);\n                            }\n                            answerEl.data('annotated', 1);\n                        }\n                        $('#answer_wrapper_' + a).attr('data-ally-richcontent', annotation);\n                    }\n                }\n\n                // Annotate answer responses.\n                var responses = mapping['lesson_answers_response'];\n                for (var r in responses) {\n                    var annotation = responses[r];\n\n                    var tmpArr = r.split('_');\n                    var pageId = tmpArr[0];\n                    var respId = tmpArr[1];\n                    var rnum = tmpArr[2];\n\n                    if (document.body.id === \"page-mod-lesson-edit\") {\n                        processAnswerResponse(pageId, rnum, responseLabel, annotation);\n                    } else if (self.params.answerid && self.params.answerid == respId) {\n                        // Just incase you are wondering, yes answer ids ^ are the same as response ids ;-).\n                        var responseWrapperId = 'response_wrapper_' + respId;\n                        if (!$('.studentanswer tr.lastrow > td #' + responseWrapperId).length) {\n                            // We only want to wrap this once, hence above ! length check.\n                            var contentEls = $('.studentanswer tr.lastrow > td > br').nextAll();\n                            $('.studentanswer tr.lastrow > td > br').after('<span id=\"' + responseWrapperId + '\"></span>');\n                            $('#' + responseWrapperId).append(contentEls);\n                        }\n\n                        $('#' + responseWrapperId).attr('data-ally-richcontent', annotation);\n                    }\n\n                }\n            });\n        };\n\n        /**\n         * Annotate supported modules\n         * @param moduleMapping\n         */\n        var annotateModules = function(moduleMapping) {\n            var dfd = $.Deferred();\n            if (moduleMapping['mod_forum'] !== undefined) {\n                annotateForums(moduleMapping['mod_forum']);\n            }\n            if (moduleMapping['mod_hsuforum'] !== undefined) {\n                annotateMRForums(moduleMapping['mod_hsuforum']);\n            }\n            if (moduleMapping['mod_glossary'] !== undefined) {\n                annotateGlossary(moduleMapping['mod_glossary']);\n            }\n            if (moduleMapping['mod_page'] !== undefined) {\n                annotatePage(moduleMapping['mod_page']);\n            }\n            if (moduleMapping['mod_book'] !== undefined) {\n                annotateBook(moduleMapping['mod_book']);\n            }\n            if (moduleMapping['mod_lesson'] !== undefined) {\n                annotateLesson(moduleMapping['mod_lesson']);\n            }\n            dfd.resolve();\n            return dfd.promise();\n        };\n\n        /**\n         * Annotates course summary if found on footer.\n         * @param mapping\n         */\n        var annotateSnapCourseSummary = function(mapping) {\n            var dfd = $.Deferred();\n            var snapFooterCourseSummary = $('#snap-course-footer-summary > div.no-overflow');\n            if (snapFooterCourseSummary.length) {\n                var ident = buildContentIdent('course', 'course', 'summary', mapping.courseId);\n                snapFooterCourseSummary.attr('data-ally-richcontent', ident);\n            }\n            dfd.resolve();\n            return dfd.promise();\n        };\n\n        /**\n         * Annotate html block.\n         * @param mapping\n         */\n        var annotateHtmlBlock = function(mapping) {\n            var dfd = $.Deferred();\n\n            var items = mapping.block_html;\n            for (var i in items) {\n                var ident = items[i];\n                var selectors = [\n                    '#inst' + i + '.block_html > .card-body > .card-text > .no-overflow',\n                    '#inst' + i + '.block_html > .content > .no-overflow'\n                ];\n                var selector = selectors.join(',');\n                $(selector).attr('data-ally-richcontent', ident);\n            }\n            dfd.resolve();\n            return dfd.promise();\n        };\n\n        /**\n         * Apply place holders and add annotations to content.\n         * @return {promise}\n         */\n        var applyPlaceHolders = function() {\n            M.util.js_pending('filter_ally_applyPlaceHolders');\n            var dfd = $.Deferred();\n\n            if (ally_module_maps === undefined || ally_section_maps === undefined) {\n                dfd.resolve();\n                return dfd.promise();\n            }\n\n            var tasks = [{\n                mapVar: ally_module_maps.file_resources,\n                method: placeHoldResourceModule\n            },\n            {\n                mapVar: ally_module_maps.assignment_files,\n                method: placeHoldAssignModule\n            },\n            {\n                mapVar: ally_module_maps.folder_files,\n                method: placeHoldFolderModule\n            },\n            {\n                mapVar: ally_module_maps.forum_files,\n                method: placeHoldForumModule\n            },\n            {\n                mapVar: ally_module_maps.glossary_files,\n                method: placeHoldGlossaryModule\n            },\n            {\n                mapVar: ally_module_maps.lesson_files,\n                method: placeHoldLessonModule\n            },\n            {\n                mapVar: ally_section_maps,\n                method: annotateSections\n            },\n            {\n                mapVar: ally_annotation_maps,\n                method: annotateModules\n            },\n            {\n                mapVar: {courseId: self.courseId},\n                method: annotateSnapCourseSummary\n            },\n            {\n                mapVar: ally_annotation_maps,\n                method: annotateHtmlBlock\n            }];\n\n            $(document).ready(function() {\n                var completed = 0;\n                /**\n                 * Run this once a task has resolved.\n                 */\n                var onTaskComplete = function() {\n                    completed++;\n                    if (completed === tasks.length) {\n                        // All tasks completed.\n                        M.util.js_complete('filter_ally_applyPlaceHolders');\n                        dfd.resolve();\n                    }\n                };\n\n                for (var t in tasks) {\n                    var task = tasks[t];\n                    if (Object.keys(task.mapVar).length > 0) {\n                        task.method(task.mapVar)\n                            .done(onTaskComplete);\n                    } else {\n                        // Skipped this task because mappings are empty.\n                        onTaskComplete();\n                    }\n                }\n            });\n            return dfd.promise();\n        };\n\n        var debounceApplyPlaceHolders = Util.debounce(function() {\n            return applyPlaceHolders();\n        }, 1000);\n\n        /**\n         * Initialise JS stage two.\n         * @param jwt\n         * @param {object} config\n         */\n        this.initStageTwo = function(jwt, config) {\n            if (self.canViewFeedback || self.canDownload) {\n                debounceApplyPlaceHolders()\n                    .done(function() {\n                        ImageCover.init();\n                        Ally.init(jwt, config);\n                        try {\n                            var selector = $('.foldertree > .filemanager');\n                            var targetNode = selector[0];\n                            var observerConfig = { attributes: true, childList: true, subtree: true };\n                            var callback = function(mutationsList) {\n                                mutationsList.filter( function (mutation) {\n                                    return mutation.type === 'childList';\n                                }).forEach( function () {\n                                    placeHoldFolderModule(ally_module_maps.folder_files);\n                                });\n                            };\n                            var observer = new MutationObserver(callback);\n                            observer.observe(targetNode, observerConfig);\n                        } catch (error) {\n                            setInterval(function() {\n                                placeHoldFolderModule(ally_module_maps.folder_files);\n                            }, 5000);\n                        }\n                        self.initialised = true;\n                    });\n\n                $(document).ajaxComplete(function() {\n                    if (!self.initialised) {\n                        return;\n                    }\n                    debounceApplyPlaceHolders();\n                });\n            }\n        };\n\n        /**\n         * Init function.\n         * @param jwt\n         * @param {object} config\n         * @param {boolean} canViewFeedback\n         * @param {boolean} canDownload\n         * @param {int} courseId\n         * @param {object} general params\n         */\n        this.init = function(jwt, config, canViewFeedback, canDownload, courseId, params) {\n\n            self.canViewFeedback = canViewFeedback;\n            self.canDownload = canDownload;\n            self.courseId = courseId;\n            self.params = params;\n\n            var pluginJSURL = function(path) {\n                return M.cfg.wwwroot + \"/pluginfile.php/\" + M.cfg.contextid + \"/filter_ally/\" + path;\n            };\n\n            var polyfills = {};\n            if (!document.evaluate) {\n                polyfills['filter_ally/wgxpath'] = pluginJSURL(\"vendorjs/wgxpath.install\");\n            }\n            if (typeof(URLSearchParams) === 'undefined') {\n                polyfills['filter_ally/urlsearchparams'] = [\n                    'https://cdnjs.cloudflare.com/ajax/libs/url-search-params/1.1.0/url-search-params.amd.js',\n                    pluginJSURL('vendorjs/url-search-params.amd') // CDN fallback.\n                ];\n            }\n            if (polyfills !== {}) {\n                // Polyfill document.evaluate.\n                require.config(\n                    {\n                        enforceDefine: false,\n                        paths: polyfills\n                    }\n                );\n                var requires = Object.keys(polyfills);\n\n                require(requires, function() {\n                    if (typeof(URLSearchParams) === 'undefined') {\n                        window.URLSearchParams = arguments[1]; // second arg in require (which is URLSearchParams)\n                    }\n                    self.initStageTwo(jwt, config);\n                });\n\n                return;\n            }\n            self.initStageTwo(jwt, config);\n        };\n    };\n});\n"],"file":"main.min.js"}