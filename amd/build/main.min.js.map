{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * Main library.\n *\n * @package\n * @author    Guy Thomas\n * @copyright Copyright (c) 2016 Open LMS / 2023 Anthology Inc. and its affiliates\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from \"jquery\";\nimport Templates from \"core/templates\";\nimport {get_strings} from \"core/str\";\nimport Ally from \"filter_ally/ally\";\nimport ImageCover from \"filter_ally/imagecover\";\nimport Util from \"filter_ally/util\";\n\n/**\n * Main filter ally class\n */\nclass FilterAllyMain {\n  constructor() {\n    this.canViewFeedback = false;\n    this.canDownload = false;\n    this.initialised = false;\n    this.params = {};\n    this.observedNodes = new WeakSet();\n    this.jwt = null;\n    this.config = null;\n    this.courseId = null;\n\n    // Setup event listener for content updates\n    document.addEventListener(\"core_filters/contentUpdated\", () => {\n      // When Snap lazy loads a section it triggers this event.\n      // We can ensure everything has been processed on lazy load by recalling the second\n      // stage initialization.\n      this.initStageTwo();\n    });\n  }\n\n  /**\n   * Get nodes by xpath.\n   * @param {string} xpath\n   * @returns {Array}\n   */\n  getNodesByXpath(xpath) {\n    const expression = window.document.createExpression(xpath);\n    const result = expression.evaluate(window.document, XPathResult.ANY_TYPE);\n    const nodes = [];\n    let node;\n    do {\n      node = result.iterateNext();\n      if (node) {\n        nodes.push(node);\n      }\n    } while (node);\n    return nodes;\n  }\n\n  /**\n   * Get single node by xpath.\n   * @param {string} xpath\n   * @returns {Node}\n   */\n  getNodeByXpath(xpath) {\n    const expression = window.document.createExpression(xpath);\n    const result = expression.evaluate(\n      window.document,\n      XPathResult.FIRST_ORDERED_NODE_TYPE\n    );\n    return result.singleNodeValue;\n  }\n\n  /**\n   * Render template and insert result in appropriate place.\n   * @param {object} data\n   * @param {string} pathHash\n   * @param {node} targetEl\n   * @return {promise}\n   */\n  renderTemplate(data, pathHash, targetEl) {\n    const dfd = $.Deferred();\n\n    if ($(targetEl).parents(\".filter-ally-wrapper\").length) {\n      // This has already been processed.\n      dfd.resolve();\n      return dfd.promise();\n    }\n\n    // Too expensive to do at module level - this is a course level capability.\n    data.canviewfeedback = this.canViewFeedback;\n    data.candownload = this.canDownload;\n    data.html = '<span id=\"content-target-' + pathHash + '\"></span>';\n\n    Templates.render(\"filter_ally/wrapper\", data).done(function(result) {\n      const presentWrappers = $(targetEl)\n        .next()\n        .find('span[data-file-id=\"' + pathHash + '\"]');\n      if (presentWrappers.length === 0) {\n        $(targetEl).after(result);\n\n        // We are inserting the module element next to the target as opposed to replacing the\n        // target as we want to ensure any listeners attributed to the module element persist.\n        $(\"#content-target-\" + pathHash).after(targetEl);\n        $(\"#content-target-\" + pathHash).remove();\n      }\n      dfd.resolve();\n    });\n\n    return dfd.promise();\n  }\n\n  /**\n   * Place holder items that are matched by selector.\n   * @param {string} selector\n   * @param {string} map\n   * @return {promise}\n   */\n  placeHoldSelector(selector, map) {\n    const dfd = $.Deferred();\n    let c = 0;\n    const length = $(selector).length;\n\n    if (!length) {\n      dfd.resolve();\n      return dfd.promise();\n    }\n\n    $(selector).each((_idx, el) => {\n      /**\n       * Check that all selectors have been processed.\n       */\n      const checkComplete = () => {\n        if (c === length) {\n          dfd.resolve();\n        }\n      };\n\n      let url, type;\n      const element = $(el);\n\n      if (element.prop(\"tagName\").toLowerCase() === \"a\") {\n        url = element.attr(\"href\");\n        type = \"a\";\n      } else {\n        url = element.attr(\"src\");\n        type = \"img\";\n      }\n\n      let regex;\n      if (url.indexOf(\"?\") > -1) {\n        regex = /pluginfile.php\\/(\\d*)\\/(.*)(\\?)/;\n      } else {\n        regex = /pluginfile.php\\/(\\d*)\\/(.*)/;\n      }\n\n      const match = url.match(regex);\n      let pathHash;\n\n      if (match) {\n        let path = match[1] + \"/\" + match[2];\n        path = decodeURIComponent(path);\n        pathHash = map[path];\n      }\n\n      if (pathHash === undefined) {\n        // Maybe 'slasharguments' setting is disabled for this host.\n        // Let's see if the file URI is found in the URL query.\n        const query = Util.getQuery(url);\n        if (query.file) {\n          const filePath = decodeURIComponent(query.file);\n          regex = /\\/(\\d*)\\/(.*)/;\n\n          const fileMatch = filePath.match(regex);\n          if (fileMatch) {\n            let path = fileMatch[1] + \"/\" + fileMatch[2];\n            path = decodeURIComponent(path);\n            pathHash = map[path];\n          }\n        }\n      }\n\n      // Pathhash was definitely not found :( .\n      if (pathHash === undefined) {\n        c++;\n        checkComplete();\n        return;\n      }\n\n      const data = {\n        isimage: type === \"img\",\n        fileid: pathHash,\n        url: url,\n      };\n\n      this.renderTemplate(data, pathHash, element).done(() => {\n        c++;\n        checkComplete();\n      });\n    });\n\n    return dfd.promise();\n  }\n\n  /**\n   * Add place holders for forum module image attachments (note, regular files are covered by php).\n   * @param {array} forumFileMapping\n   * @return {promise}\n   */\n  placeHoldForumModule(forumFileMapping) {\n    const dfd = $.Deferred();\n    this.placeHoldSelector(\n      '.forumpost .attachedimages img[src*=\"pluginfile.php\"], ' +\n        '.forumpost .body-content-container a[href*=\"pluginfile.php\"]',\n      forumFileMapping\n    ).done(() => {\n      dfd.resolve();\n    });\n    return dfd.promise();\n  }\n\n  /**\n   * Add place holders for assign module additional files.\n   * @param {array} assignFileMapping\n   * @return {promise}\n   */\n  placeHoldAssignModule(assignFileMapping) {\n    const dfd = $.Deferred();\n    console.log('!!!placeHoldAssignModule');\n    Util.whenTrue(() => {\n      console.log('!!!checking assign files tree on page');\n      return $('div[id*=\"assign_files_tree\"] .ygtvitem').length > 0;\n    }, 10).done(() => {\n      console.log('!!!placeholding selector');\n      this.placeHoldSelector(\n        'div[id*=\"assign_files_tree\"] a[href*=\"pluginfile.php\"]',\n        assignFileMapping\n      );\n      dfd.resolve();\n    });\n    return dfd.promise();\n  }\n\n  /**\n   * Add place holders for folder module files.\n   * @param {array} folderFileMapping\n   * @return {promise}\n   */\n  placeHoldFolderModule(folderFileMapping) {\n    const dfd = $.Deferred();\n    Util.whenTrue(() => {\n      return $(\".foldertree > .filemanager .ygtvitem\").length > 0;\n    }, 10).done(() => {\n      const unwrappedlinks =\n        '.foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*=\"pluginfile.php\"]';\n      this.placeHoldSelector(unwrappedlinks, folderFileMapping).done(() => {\n        dfd.resolve();\n      });\n    });\n    return dfd.promise();\n  }\n\n  /**\n   * Add place holders for glossary module files.\n   * @param {array} glossaryFileMapping\n   * @return {promise}\n   */\n  placeHoldGlossaryModule(glossaryFileMapping) {\n    const dfd = $.Deferred();\n\n    // Glossary attachment markup is terrible!\n    // The first thing we need to do is rewrite the glossary attachments so that they are encapsulated.\n    $(\".entry .attachments > br\").each(function() {\n      const mainAnchor = $(this).prev('a[href*=\"pluginfile.php\"]');\n      mainAnchor.addClass(\"ally-glossary-attachment\");\n      const iconAnchor = $(mainAnchor).prev('a[href*=\"pluginfile.php\"]');\n      $(this).after('<div class=\"ally-glossary-attachment-row\"></div>');\n      const container = $(this).next(\".ally-glossary-attachment-row\");\n      container.append(iconAnchor);\n      container.append(mainAnchor);\n      $(this).remove();\n    });\n\n    const unwrappedlinks = \".entry .attachments .ally-glossary-attachment\";\n    this.placeHoldSelector(unwrappedlinks, glossaryFileMapping).done(() => {\n      dfd.resolve();\n    });\n    return dfd.promise();\n  }\n\n  /**\n   * Encode a file path so that it can be used to find things by uri.\n   * @param {string} filePath\n   * @returns {string}\n   */\n  urlEncodeFilePath(filePath) {\n    const parts = filePath.split(\"/\");\n    for (const p in parts) {\n      parts[p] = encodeURIComponent(parts[p]);\n    }\n    return parts.join(\"/\");\n  }\n\n  /**\n   * General function for finding lesson component file elements and then add mapping.\n   * @param {array} map\n   * @param {string} selectorPrefix\n   * @return promise\n   */\n  placeHoldLessonGeneral(map, selectorPrefix) {\n    const dfd = $.Deferred();\n    if (map.length === 0) {\n      dfd.resolve();\n    } else {\n      for (const c in map) {\n        const path = this.urlEncodeFilePath(c);\n        const sel =\n          selectorPrefix +\n          'img[src*=\"' +\n          path +\n          '\"], ' +\n          selectorPrefix +\n          'a[href*=\"' +\n          path +\n          '\"]';\n        this.placeHoldSelector(sel, map).done(() => {\n          dfd.resolve();\n        });\n      }\n    }\n    return dfd.promise();\n  }\n\n  /**\n   * Placehold lesson page contents.\n   * @param {array} pageContentsMap\n   * @returns promise\n   */\n  placeHoldLessonPageContents(pageContentsMap) {\n    return this.placeHoldLessonGeneral(pageContentsMap, \"\");\n  }\n\n  /**\n   * Placehold lesson answers.\n   * @param {array} pageAnswersMap\n   * @returns promise\n   */\n  placeHoldLessonAnswersContent(pageAnswersMap) {\n    return this.placeHoldLessonGeneral(\n      pageAnswersMap,\n      \".studentanswer table tr:nth-child(1) \"\n    ); // Space at end of selector intended.\n  }\n\n  /**\n   * Placehold lesson responses.\n   * @param {array} pageResponsesMap\n   * @returns promise\n   */\n  placeHoldLessonResponsesContent(pageResponsesMap) {\n    return this.placeHoldLessonGeneral(\n      pageResponsesMap,\n      \".studentanswer table tr.lastrow \"\n    ); // Space at end of selector intended.\n  }\n\n  /**\n   * Add place holders for lesson module files.\n   * @param {array} lessonFileMapping\n   * @return {promise}\n   */\n  placeHoldLessonModule(lessonFileMapping) {\n    const dfd = $.Deferred();\n\n    const pageContentsMap = lessonFileMapping.page_contents;\n    const pageAnswersMap = lessonFileMapping.page_answers;\n    const pageResponsesMap = lessonFileMapping.page_responses;\n\n    this.placeHoldLessonPageContents(pageContentsMap)\n      .then(() => {\n        return this.placeHoldLessonAnswersContent(pageAnswersMap);\n      })\n      .then(() => {\n        return this.placeHoldLessonResponsesContent(pageResponsesMap);\n      })\n      .then(() => {\n        dfd.resolve();\n      });\n    return dfd.promise();\n  }\n\n  /**\n   * Add place holders for resource module.\n   * @param {object} moduleFileMapping\n   * @return {promise}\n   */\n  placeHoldResourceModule(moduleFileMapping) {\n    const dfd = $.Deferred();\n    let c = 0;\n\n    /**\n     * Once all modules processed, resolve promise for this function.\n     */\n    const checkAllProcessed = () => {\n      c++;\n      // All resource modules have been dealt with.\n      if (c >= Object.keys(moduleFileMapping).length) {\n        dfd.resolve();\n      }\n    };\n\n    for (const moduleId in moduleFileMapping) {\n      const pathHash = moduleFileMapping[moduleId].content;\n      let moduleEl;\n      if (\n        $(\"body\").hasClass(\"theme-snap\") &&\n        !$(\"body\").hasClass(\"format-tiles\")\n      ) {\n        moduleEl = $(\n          \"#module-\" +\n            moduleId +\n            \":not(.snap-native) .activityinstance \" +\n            \".snap-asset-link a:first-of-type:not(.clickable-region)\"\n        );\n      } else {\n        moduleEl = $(\n          \"#module-\" +\n            moduleId +\n            \" .activity-instance \" +\n            \"a:first-of-type:not(.clickable-region,.editing_move)\"\n        );\n      }\n      const processed = moduleEl.find(\".filter-ally-wrapper\");\n      if (processed.length > 0) {\n        checkAllProcessed(); // Already processed.\n        continue;\n      }\n      const data = {\n        isimage: false,\n        fileid: pathHash,\n        url: $(moduleEl).attr(\"href\"),\n      };\n      this.renderTemplate(data, pathHash, moduleEl).done(checkAllProcessed);\n    }\n    return dfd.promise();\n  }\n\n  /**\n   * Build content identifier string.\n   * @param {string} component\n   * @param {string} table\n   * @param {string} field\n   * @param {string} id\n   * @returns {string}\n   */\n  buildContentIdent(component, table, field, id) {\n    return [component, table, field, id].join(\":\");\n  }\n\n  /**\n   * Add annotations to sections content.\n   * @param {array} sectionMapping\n   */\n  annotateSections(sectionMapping) {\n    const dfd = $.Deferred();\n\n    for (const s in sectionMapping) {\n      const sectionId = sectionMapping[s];\n      const ident = this.buildContentIdent(\n        \"course\",\n        \"course_sections\",\n        \"summary\",\n        sectionId\n      );\n\n      const selectors = [\n        \"#\" + s + ' > .content div[class*=\"summarytext\"] .no-overflow',\n        \"#\" + s + ' > .section-item div[class*=\"summarytext\"] .no-overflow', // Moodle 4.4+\n        \"body.theme-snap #\" + s + \" > .content > .summary > div > .no-overflow\", // Snap.\n      ];\n      $(selectors.join(\",\")).attr(\"data-ally-richcontent\", ident);\n    }\n\n    dfd.resolve();\n    return dfd.promise();\n  }\n\n  /**\n   * Annotate module introductions.\n   * @param {array} introMapping\n   * @param {string} module\n   * @param {array} additionalSelectors\n   */\n  annotateModuleIntros(introMapping, module, additionalSelectors) {\n    for (const i in introMapping) {\n      const annotation = introMapping[i];\n\n      // Description selector for when activity modules show a description on the course page.\n      // We need to be specific here for non course pages to skip this.\n      const descriptionSelector =\n        this.config.moodleversion >= 2023100900\n          ? // Selector for Moodle 4.3+\n            \"li.activity.modtype_\" +\n            module +\n            \"#module-\" +\n            i +\n            \" .activity-description .no-overflow > .no-overflow\"\n          : // Selector for < Moodle 4.3\n            \"li.activity.modtype_\" +\n            module +\n            \"#module-\" +\n            i +\n            \" .description .no-overflow > .no-overflow\";\n\n      const selectors = [\n        \"body.path-mod-\" + module + \".cmid-\" + i + \" #intro > .no-overflow\",\n        descriptionSelector,\n        \"li.snap-activity.modtype_\" +\n          module +\n          \"#module-\" +\n          i +\n          \" .contentafterlink > .no-overflow\",\n      ];\n\n      if (additionalSelectors) {\n        for (const a in additionalSelectors) {\n          selectors.push(additionalSelectors[a].replace(\"{{i}}\", i));\n        }\n      }\n      $(selectors.join(\",\")).attr(\"data-ally-richcontent\", annotation);\n    }\n  }\n\n  /**\n   * Add annotations to forums.\n   * @param {array} forumMapping\n   */\n  annotateForums(forumMapping) {\n    // Annotate introductions.\n    const intros = forumMapping.intros;\n    this.annotateModuleIntros(intros, \"forum\");\n\n    // Annotate discussions.\n    const discussions = forumMapping.posts;\n    for (const d in discussions) {\n      const post = \"p\" + d;\n      const annotation = discussions[d];\n      const selectors = [\n        \"#page-mod-forum-discuss #\" + post + \" div.forumpost div.no-overflow\",\n      ];\n      $(selectors.join(\",\")).attr(\"data-ally-richcontent\", annotation);\n    }\n  }\n\n  /**\n   * Add annotations to Open Forums.\n   * @param {array} forumMapping\n   */\n  annotateMRForums(forumMapping) {\n    // Annotate introductions.\n    const intros = forumMapping.intros;\n    this.annotateModuleIntros(intros, \"hsuforum\", [\n      \"#hsuforum-header .hsuforum_introduction > .no-overflow\",\n    ]);\n\n    const discussions = forumMapping.posts;\n    for (const d in discussions) {\n      const annotation = discussions[d];\n      const postSelector = 'article[id=\"p' + d + '\"] div.posting';\n      $(postSelector).attr(\"data-ally-richcontent\", annotation);\n    }\n  }\n\n  /**\n   * Add annotations to glossary.\n   * @param {array} mapping\n   */\n  annotateGlossary(mapping) {\n    // Annotate introductions.\n    const intros = mapping.intros;\n    this.annotateModuleIntros(intros, \"glossary\");\n\n    // Annotate entries.\n    const entries = mapping.entries;\n    for (const e in entries) {\n      const annotation = entries[e];\n      const entryFooter = $(\n        '.entrylowersection .commands a[href*=\"id=' + e + '\"]'\n      );\n      const entry = $(entryFooter)\n        .parents(\".glossarypost\")\n        .find(\".entry .no-overflow\");\n      $(entry).attr(\"data-ally-richcontent\", annotation);\n    }\n  }\n\n  /**\n   * Add annotations to page.\n   * @param {array} mapping\n   */\n  annotatePage(mapping) {\n    const intros = mapping.intros;\n    this.annotateModuleIntros(intros, \"page\", [\n      \"li.snap-native.modtype_page#module-{{i}} .contentafterlink > .summary-text\",\n    ]);\n\n    // Annotate content.\n    const content = mapping.content;\n    for (const c in content) {\n      const annotation = content[c];\n      const selectors = [\n        `#page-mod-page-view.cmid-${c} #region-main .box.generalbox > .no-overflow`,\n        `li.snap-native.modtype_page#module-${c} .pagemod-content`,\n      ];\n      $(selectors.join(\",\")).attr(\"data-ally-richcontent\", annotation);\n    }\n  }\n\n  /**\n   * Add annotations to book.\n   * @param {array} mapping\n   */\n  annotateBook(mapping) {\n    const intros = mapping.intros;\n\n    // For book, the only place the intro shows is on the course page when you select \"display description on course page\"\n    // in the module settings.\n    this.annotateModuleIntros(intros, \"book\", [\n      \"li.snap-native.modtype_book#module-{{i}} .contentafterlink > .summary-text .no-overflow\",\n    ]);\n\n    // Annotate content.\n    const content = mapping.chapters;\n    let chapterId;\n\n    if (this.params.chapterid) {\n      chapterId = this.params.chapterid;\n    } else {\n      const urlParams = new URLSearchParams(window.location.search);\n      chapterId = urlParams.get(\"chapterid\");\n    }\n\n    $.each(content, (ch, annotation) => {\n      if (chapterId != ch) {\n        return;\n      }\n      const selectors = [\n        \"#page-mod-book-view #region-main .box.generalbox.book_content > .no-overflow\",\n        \"li.snap-native.modtype_page#module-\" + ch + \" .pagemod-content\",\n      ];\n      $(selectors.join(\",\")).attr(\"data-ally-richcontent\", annotation);\n    });\n  }\n\n  /**\n   * Add annotations to lesson.\n   * @param {array} mapping\n   */\n  /**\n   * Add annotations to lesson.\n   * @param {array} mapping\n   */\n  annotateLesson(mapping) {\n    const intros = mapping.intros;\n\n    // For lesson, the only place the intro shows is on the course page when you select \"display description on course page\"\n    // in the module settings.\n    this.annotateModuleIntros(intros, \"lesson\", [\n      \"li.snap-native.modtype_lesson#module-{{i}} .contentafterlink > .summary-text .no-overflow\",\n    ]);\n\n    // Annotate content.\n    const content = mapping.lesson_pages;\n\n    for (const p in content) {\n      if (document.body.id === \"page-mod-lesson-edit\") {\n        const xpath =\n          '//a[@id=\"lesson-' +\n          p +\n          '\"]//ancestor::table//tbody/tr/td/div[contains(@class, \"no-overflow\")]';\n        const annotation = content[p];\n        const node = this.getNodeByXpath(xpath);\n        $(node).attr(\"data-ally-richcontent\", annotation);\n      } else {\n        // Try get page from form.\n        const node = this.getNodeByXpath(\n          '//form[contains(@action, \"continue.php\")]//input[@name=\"pageid\"]'\n        );\n        let pageId;\n        if (node) {\n          pageId = $(node).val();\n        } else {\n          const urlParams = new URLSearchParams(window.location.search);\n          pageId = urlParams.get(\"pageid\");\n        }\n\n        if (pageId != p) {\n          continue;\n        }\n        const annotation = content[p];\n        const selectors = [\n          // Regular page.\n          \"#page-mod-lesson-view #region-main .box.contents > .no-overflow\",\n          // Question page.\n          \"#page-mod-lesson-view #region-main form > fieldset > .fcontainer > .contents .no-overflow\",\n          // Lesson page.\n          \"li.snap-native.modtype_page#module-\" + p + \" .pagemod-content\",\n        ];\n\n        $(selectors.join(\",\")).attr(\"data-ally-richcontent\", annotation);\n      }\n    }\n\n    // Annotate answer answers.\n    get_strings([\n      {key: \"answer\", component: \"mod_lesson\"},\n      {key: \"response\", component: \"mod_lesson\"},\n    ]).then((strings) => {\n      const answerLabel = strings[0];\n      const responseLabel = strings[1];\n      const answers = mapping.lesson_answers;\n\n      const processAnswerResponse = (pageId, i, label, annotation) => {\n        const xpath =\n          '//a[@id=\"lesson-' +\n          pageId +\n          '\"]//ancestor::table' +\n          '//td/label[contains(text(),\"' +\n          label +\n          \" \" +\n          i +\n          '\")]/ancestor::tr/td[2]';\n        const nodes = this.getNodesByXpath(xpath);\n        for (const n in nodes) {\n          const node = nodes[n];\n          $(node).attr(\"data-ally-richcontent\", annotation);\n        }\n      };\n\n      for (const a in answers) {\n        // Increment anum so that we can get the answer number.\n        // Note, we can trust that this is correct because you can't order answers and the code in the lesson component\n        // orders answers by id.\n        const annotation = answers[a];\n\n        const tmpArr = a.split(\"_\");\n        const pageId = tmpArr[0];\n        const ansId = tmpArr[1];\n        const anum = tmpArr[2];\n\n        // Process answers when on lesson edit page.\n        if (document.body.id === \"page-mod-lesson-edit\") {\n          processAnswerResponse(pageId, anum, answerLabel, annotation);\n        } else {\n          // Wrap answers in labels.\n          $(\n            '#page-mod-lesson-view label[for=\"id_answerid_' + ansId + '\"]'\n          ).attr(\"data-ally-richcontent\", annotation);\n\n          if (this.params.answerid && this.params.answerid == ansId) {\n            $(\".studentanswer tr:nth-of-type(1) > td div\").attr(\n              \"data-ally-richcontent\",\n              annotation\n            );\n          } else {\n            const answerWrapperId = \"answer_wrapper_\" + ansId;\n            const answerEl = $(\"#id_answerid_\" + ansId);\n            if (answerEl.data(\"annotated\") != 1) {\n              // We only want to wrap this once.\n              const contentEls = answerEl.nextAll();\n              answerEl\n                .parent(\"label\")\n                .append('<span id=\"answer_wrapper_' + ansId + '\"></span>');\n              $(\"#\" + answerWrapperId).append(contentEls);\n            }\n            answerEl.data(\"annotated\", 1);\n          }\n          $(\"#answer_wrapper_\" + a).attr(\"data-ally-richcontent\", annotation);\n        }\n      }\n\n      // Annotate answer responses.\n      const responses = mapping.lesson_answers_response;\n      for (const r in responses) {\n        const annotation = responses[r];\n\n        const tmpArr = r.split(\"_\");\n        const pageId = tmpArr[0];\n        const respId = tmpArr[1];\n        const rnum = tmpArr[2];\n\n        if (document.body.id === \"page-mod-lesson-edit\") {\n          processAnswerResponse(pageId, rnum, responseLabel, annotation);\n        } else if (this.params.answerid && this.params.answerid == respId) {\n          // Just incase you are wondering, yes answer ids ^ are the same as response ids ;-).\n          const responseWrapperId = \"response_wrapper_\" + respId;\n          if (\n            !$(\".studentanswer tr.lastrow > td #\" + responseWrapperId).length\n          ) {\n            // We only want to wrap this once, hence above ! length check.\n            const contentEls = $(\n              \".studentanswer tr.lastrow > td > br\"\n            ).nextAll();\n            $(\".studentanswer tr.lastrow > td > br\").after(\n              '<span id=\"' + responseWrapperId + '\"></span>'\n            );\n            $(\"#\" + responseWrapperId).append(contentEls);\n          }\n\n          $(\"#\" + responseWrapperId).attr(\"data-ally-richcontent\", annotation);\n        }\n      }\n    });\n  }\n\n  /**\n   * Annotate supported modules\n   * @param {array} moduleMapping\n   */\n  annotateModules(moduleMapping) {\n    const dfd = $.Deferred();\n\n    if (moduleMapping.mod_forum !== undefined) {\n      this.annotateForums(moduleMapping.mod_forum);\n    }\n    if (moduleMapping.mod_hsuforum !== undefined) {\n      this.annotateMRForums(moduleMapping.mod_hsuforum);\n    }\n    if (moduleMapping.mod_glossary !== undefined) {\n      this.annotateGlossary(moduleMapping.mod_glossary);\n    }\n    if (moduleMapping.mod_page !== undefined) {\n      this.annotatePage(moduleMapping.mod_page);\n    }\n    if (moduleMapping.mod_book !== undefined) {\n      this.annotateBook(moduleMapping.mod_book);\n    }\n    if (moduleMapping.mod_lesson !== undefined) {\n      this.annotateLesson(moduleMapping.mod_lesson);\n    }\n    dfd.resolve();\n    return dfd.promise();\n  }\n\n  /**\n   * Annotates course summary if found on footer.\n   * @param {object} mapping\n   */\n  annotateSnapCourseSummary(mapping) {\n    const dfd = $.Deferred();\n    const snapFooterCourseSummary = $(\n      \"#snap-course-footer-summary > div.no-overflow\"\n    );\n    if (snapFooterCourseSummary.length) {\n      const ident = this.buildContentIdent(\n        \"course\",\n        \"course\",\n        \"summary\",\n        mapping.courseId\n      );\n      snapFooterCourseSummary.attr(\"data-ally-richcontent\", ident);\n    }\n    dfd.resolve();\n    return dfd.promise();\n  }\n\n  /**\n   * Annotate html block.\n   * @param {object} mapping\n   */\n  annotateHtmlBlock(mapping) {\n    const dfd = $.Deferred();\n\n    const items = mapping.block_html;\n    for (const i in items) {\n      const ident = items[i];\n      const selectors = [\n        \"#inst\" + i + \".block_html > .card-body > .card-text > .no-overflow\",\n        \"#inst\" + i + \".block_html > .content > .no-overflow\",\n      ];\n      const selector = selectors.join(\",\");\n      $(selector).attr(\"data-ally-richcontent\", ident);\n    }\n    dfd.resolve();\n    return dfd.promise();\n  }\n\n  /**\n   * Apply place holders and add annotations to content.\n   * @return {promise}\n   */\n  applyPlaceHolders() {\n    M.util.js_pending(\"filter_ally_applyPlaceHolders\");\n    const dfd = $.Deferred();\n\n    if (ally_module_maps === undefined || ally_section_maps === undefined) {\n      dfd.resolve();\n      return dfd.promise();\n    }\n\n    const tasks = [\n      {\n        mapVar: ally_module_maps.file_resources,\n        method: this.placeHoldResourceModule.bind(this),\n      },\n      {\n        mapVar: ally_module_maps.assignment_files,\n        method: this.placeHoldAssignModule.bind(this),\n      },\n      {\n        mapVar: ally_module_maps.folder_files,\n        method: this.placeHoldFolderModule.bind(this),\n      },\n      {\n        mapVar: ally_module_maps.forum_files,\n        method: this.placeHoldForumModule.bind(this),\n      },\n      {\n        mapVar: ally_module_maps.glossary_files,\n        method: this.placeHoldGlossaryModule.bind(this),\n      },\n      {\n        mapVar: ally_module_maps.lesson_files,\n        method: this.placeHoldLessonModule.bind(this),\n      },\n      {\n        mapVar: ally_section_maps,\n        method: this.annotateSections.bind(this),\n      },\n      {\n        mapVar: ally_annotation_maps,\n        method: this.annotateModules.bind(this),\n      },\n      {\n        mapVar: {courseId: this.courseId},\n        method: this.annotateSnapCourseSummary.bind(this),\n      },\n      {\n        mapVar: ally_annotation_maps,\n        method: this.annotateHtmlBlock.bind(this),\n      },\n    ];\n\n    $(document).ready(() => {\n      let completed = 0;\n      /**\n       * Run this once a task has resolved.\n       */\n      const onTaskComplete = () => {\n        completed++;\n        if (completed === tasks.length) {\n          // All tasks completed.\n          M.util.js_complete(\"filter_ally_applyPlaceHolders\");\n          dfd.resolve();\n        }\n      };\n\n      for (const t in tasks) {\n        const task = tasks[t];\n        if (Object.keys(task.mapVar).length > 0) {\n          task.method(task.mapVar).done(onTaskComplete);\n        } else {\n          // Skipped this task because mappings are empty.\n          onTaskComplete();\n        }\n      }\n    });\n    return dfd.promise();\n  }\n\n  /**\n   * Initialise JS stage two.\n   */\n  initStageTwo() {\n    const {jwt, config} = this;\n    if (this.canViewFeedback || this.canDownload) {\n      this.debounceApplyPlaceHolders().done(() => {\n        ImageCover.init();\n        Ally.init(jwt, config);\n        try {\n          const selector = $(\".foldertree > .filemanager\");\n          const targetNode = selector[0];\n          if (targetNode) {\n            const observerConfig = {\n              attributes: true,\n              childList: true,\n              subtree: true,\n            };\n            const callback = (mutationsList) => {\n              mutationsList\n                .filter((mutation) => {\n                  return mutation.type === \"childList\";\n                })\n                .forEach(() => {\n                  this.placeHoldFolderModule(ally_module_maps.folder_files);\n                });\n            };\n            const observer = new MutationObserver(callback);\n\n            // Avoid observing the same DOM node multiple times.\n            // Note: If a node is removed and reinserted into the DOM, it becomes a new object reference.\n            // This check will allow re-observing such new nodes, which is desirable,\n            // since the original observer won't persist across DOM removal.\n            if (!this.observedNodes.has(targetNode)) {\n              observer.observe(targetNode, observerConfig);\n              this.observedNodes.add(targetNode);\n            }\n          }\n        } catch (error) {\n          setInterval(() => {\n            this.placeHoldFolderModule(ally_module_maps.folder_files);\n          }, 5000);\n        }\n        this.initialised = true;\n      });\n\n      $(document).ajaxComplete(() => {\n        if (!this.initialised) {\n          return;\n        }\n        this.debounceApplyPlaceHolders();\n      });\n      // For Snap theme.\n      if ($(\"body.theme-snap\").length) {\n        $(document).ajaxComplete((event, xhr, settings) => {\n          // Search ally server response.\n          if (settings.url.includes(\"ally.js\")) {\n            setTimeout(() => {\n              // Show score icons that are hidden, see INT-18688.\n              $(\n                \".ally-feedback.ally-active.ally-score-indicator-embedded span\"\n              ).each(function() {\n                if (this.style.display == \"none\") {\n                  this.style.display = \"block\";\n                  if (\n                    this.getAttribute(\"class\") ==\n                    \"ally-scoreindicator-container\"\n                  ) {\n                    this.style.display = \"inline-block\";\n                    this.children[0].style.display = \"inline-block\";\n                  }\n                }\n              });\n            }, 5000);\n            $(document).off(\"ajaxComplete\");\n          }\n        });\n      }\n    }\n  }\n\n  /**\n   * Init function.\n   * @param {string} jwt\n   * @param {object} config\n   * @param {boolean} canViewFeedback\n   * @param {boolean} canDownload\n   * @param {int} courseId\n   * @param {object} params\n   */\n  init(jwt, config, canViewFeedback, canDownload, courseId, params) {\n    this.canViewFeedback = canViewFeedback;\n    this.canDownload = canDownload;\n    this.courseId = courseId;\n    this.params = params;\n    this.jwt = jwt;\n    this.config = config;\n\n    const pluginJSURL = (path) => {\n      return (\n        M.cfg.wwwroot +\n        \"/pluginfile.php/\" +\n        M.cfg.contextid +\n        \"/filter_ally/\" +\n        path\n      );\n    };\n\n    const polyfills = {};\n    if (!document.evaluate) {\n      polyfills[\"filter_ally/wgxpath\"] = pluginJSURL(\n        \"vendorjs/wgxpath.install\"\n      );\n    }\n    if (typeof URLSearchParams === \"undefined\") {\n      polyfills[\"filter_ally/urlsearchparams\"] = [\n        \"https://cdnjs.cloudflare.com/ajax/libs/url-search-params/1.1.0/url-search-params.amd.js\",\n        pluginJSURL(\"vendorjs/url-search-params.amd\"), // CDN fallback.\n      ];\n    }\n    if (Object.keys(polyfills).length > 0) {\n      // Polyfill document.evaluate.\n      require.config({\n        enforceDefine: false,\n        paths: polyfills,\n      });\n      const requires = Object.keys(polyfills);\n\n      require(requires, () => {\n        if (typeof URLSearchParams === \"undefined\") {\n          window.URLSearchParams = arguments[1]; // Second arg in require (which is URLSearchParams)\n        }\n        this.initStageTwo();\n      });\n\n      return;\n    }\n    this.initStageTwo();\n  }\n\n  /**\n   * Get debounced version of applyPlaceHolders\n   * @returns {Function}\n   */\n  get debounceApplyPlaceHolders() {\n    if (!this._debounceApplyPlaceHolders) {\n      this._debounceApplyPlaceHolders = Util.debounce(() => {\n        return this.applyPlaceHolders();\n      }, 1000);\n    }\n    return this._debounceApplyPlaceHolders;\n  }\n}\n\n// Create and export an instance of FilterAllyMain\nconst filterAllyMain = new FilterAllyMain();\nexport default filterAllyMain;\n"],"names":["filterAllyMain","constructor","canViewFeedback","canDownload","initialised","params","observedNodes","WeakSet","jwt","config","courseId","document","addEventListener","initStageTwo","getNodesByXpath","xpath","result","window","createExpression","evaluate","XPathResult","ANY_TYPE","nodes","node","iterateNext","push","getNodeByXpath","FIRST_ORDERED_NODE_TYPE","singleNodeValue","renderTemplate","data","pathHash","targetEl","dfd","$","Deferred","parents","length","resolve","promise","canviewfeedback","this","candownload","html","render","done","next","find","after","remove","placeHoldSelector","selector","map","c","each","_idx","el","checkComplete","url","type","element","regex","prop","toLowerCase","attr","indexOf","match","path","decodeURIComponent","undefined","query","Util","getQuery","file","fileMatch","isimage","fileid","placeHoldForumModule","forumFileMapping","placeHoldAssignModule","assignFileMapping","console","log","whenTrue","placeHoldFolderModule","folderFileMapping","placeHoldGlossaryModule","glossaryFileMapping","mainAnchor","prev","addClass","iconAnchor","container","append","urlEncodeFilePath","filePath","parts","split","p","encodeURIComponent","join","placeHoldLessonGeneral","selectorPrefix","sel","placeHoldLessonPageContents","pageContentsMap","placeHoldLessonAnswersContent","pageAnswersMap","placeHoldLessonResponsesContent","pageResponsesMap","placeHoldLessonModule","lessonFileMapping","page_contents","page_answers","page_responses","then","placeHoldResourceModule","moduleFileMapping","checkAllProcessed","Object","keys","moduleId","content","moduleEl","hasClass","buildContentIdent","component","table","field","id","annotateSections","sectionMapping","s","sectionId","ident","selectors","annotateModuleIntros","introMapping","module","additionalSelectors","i","annotation","moodleversion","a","replace","annotateForums","forumMapping","intros","discussions","posts","d","post","annotateMRForums","postSelector","annotateGlossary","mapping","entries","e","entryFooter","entry","annotatePage","annotateBook","chapters","chapterId","chapterid","urlParams","URLSearchParams","location","search","get","ch","annotateLesson","lesson_pages","body","pageId","val","key","strings","answerLabel","responseLabel","answers","lesson_answers","processAnswerResponse","label","n","tmpArr","ansId","anum","answerid","answerWrapperId","answerEl","contentEls","nextAll","parent","responses","lesson_answers_response","r","respId","rnum","responseWrapperId","annotateModules","moduleMapping","mod_forum","mod_hsuforum","mod_glossary","mod_page","mod_book","mod_lesson","annotateSnapCourseSummary","snapFooterCourseSummary","annotateHtmlBlock","items","block_html","applyPlaceHolders","M","util","js_pending","ally_module_maps","ally_section_maps","tasks","mapVar","file_resources","method","bind","assignment_files","folder_files","forum_files","glossary_files","lesson_files","ally_annotation_maps","ready","completed","onTaskComplete","js_complete","t","task","debounceApplyPlaceHolders","init","targetNode","observerConfig","attributes","childList","subtree","observer","MutationObserver","mutationsList","filter","mutation","forEach","has","observe","add","error","setInterval","ajaxComplete","event","xhr","settings","includes","setTimeout","style","display","getAttribute","children","off","pluginJSURL","cfg","wwwroot","contextid","polyfills","require","enforceDefine","paths","requires","arguments","_debounceApplyPlaceHolders","debounce"],"mappings":"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"}