define(["jquery","core/templates","core/str","filter_ally/ally","filter_ally/imagecover","filter_ally/util"],function(a,b,c,d,e,f){return new function(){var g=this;g.canViewFeedback=!1,g.canDownload=!1,g.initialised=!1,g.params={};var h=function(a){var b=window.document.createExpression(a),c=b.evaluate(window.document,XPathResult.ANY_TYPE),d=[];do{var e=c.iterateNext();d.push(e)}while(e);return d},i=function(a){var b=window.document.createExpression(a),c=b.evaluate(window.document,XPathResult.FIRST_ORDERED_NODE_TYPE);return c.singleNodeValue},j=function(c,d,e){var f=a.Deferred();return a(e).parents(".filter-ally-wrapper").length?(f.resolve(),f.promise()):(c.canviewfeedback=g.canViewFeedback,c.candownload=g.canDownload,c.html='<span id="content-target-'+d+'"></span>',b.render("filter_ally/wrapper",c).done(function(b){var c=a(e).next().find('span[data-file-id="'+d+'"]');0==c.length&&(a(e).after(b),a("#content-target-"+d).after(e),a("#content-target-"+d).remove()),f.resolve()}),f.promise())},k=function(b,c){var d=a.Deferred(),e=0,g=a(b).length;return g||d.resolve(),a(b).each(function(){var b,h,i=function(){e===g&&d.resolve()};"a"===a(this).prop("tagName").toLowerCase()?(b=a(this).attr("href"),h="a"):(b=a(this).attr("src"),h="img");var k;k=b.indexOf("?")>-1?/pluginfile.php\/(\d*)\/(.*)(\?)/:/pluginfile.php\/(\d*)\/(.*)/;var l,m=b.match(k);if(m){var n=m[1]+"/"+m[2];n=decodeURIComponent(n),l=c[n]}if(void 0===l){var o=f.getQuery(b);if(o.file){var p=decodeURIComponent(o.file);k=/\/(\d*)\/(.*)/,m=p.match(k),m&&(n=m[1]+"/"+m[2],n=decodeURIComponent(n),l=c[n])}}if(void 0===l)return e++,void i();var q={isimage:"img"===h,fileid:l,url:b};j(q,l,a(this)).done(function(){e++,i()})}),d.promise()},l=function(b){var c=a.Deferred();return k('.forumpost .attachedimages img[src*="pluginfile.php"]',b).done(function(){c.resolve()}),c.promise()},m=function(b){var c=a.Deferred();return f.whenTrue(function(){return a('div[id*="assign_files_tree"] .ygtvitem').length>0},10).done(function(){k('div[id*="assign_files_tree"] a[href*="pluginfile.php"]',b),c.resolve()}),c.promise()},n=function(b){var c=a.Deferred();return f.whenTrue(function(){return a(".foldertree > .filemanager .ygtvitem").length>0},10).done(function(){var a='.foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*="pluginfile.php"]';k(a,b).done(function(){c.resolve()})}),c.promise()},o=function(b){var c=a.Deferred();a(".entry .attachments > br").each(function(){var b=a(this).prev('a[href*="pluginfile.php"]');b.addClass("ally-glossary-attachment");var c=a(b).prev('a[href*="pluginfile.php"]');a(this).after('<div class="ally-glossary-attachment-row"></div>');var d=a(this).next(".ally-glossary-attachment-row");d.append(c),d.append(b),a(this).remove()});var d=".entry .attachments .ally-glossary-attachment";return k(d,b).done(function(){c.resolve()}),c.promise()},p=function(a){var b=a.split("/");for(var c in b)b[c]=encodeURIComponent(b[c]);var d=b.join("/");return d},q=function(b,c){var d=a.Deferred();if(0===b.length)d.resolve();else for(var e in b){var f=p(e),g=c+'img[src*="'+f+'"], '+c+'a[href*="'+f+'"]';k(g,b).done(function(){d.resolve()})}return d.promise()},r=function(a){return q(a,"")},s=function(a){return q(a,".studentanswer table tr:nth-child(1) ")},t=function(a){return q(a,".studentanswer table tr.lastrow ")},u=function(b){var c=a.Deferred(),d=b.page_contents,e=b.page_answers,f=b.page_responses;return r(d).then(function(){return s(e)}).then(function(){return t(f)}).then(function(){c.resolve()}),c.promise()},v=function(b){var c=a.Deferred(),d=0,e=function(){d++,d>=Object.keys(b).length&&c.resolve()};for(var f in b){var g=b[f].content;if(a("body").hasClass("theme-snap"))var h=a("#module-"+f+":not(.snap-native) .activityinstance .snap-asset-link a:first-of-type");else var h=a("#module-"+f+" .activityinstance a:first-of-type");var i=h.find(".filter-ally-wrapper");if(i.length>0)e();else{var k={isimage:!1,fileid:g,url:a(h).attr("href")};j(k,g,h).done(e)}}return c.promise()},w=function(a,b,c,d){return[a,b,c,d].join(":")},x=function(b){var c=a.Deferred();for(var d in b){var e=b[d],f=w("course","course_sections","summary",e),g=["#"+d+' > .content > div[class*="summary"] > .no-overflow',"body.theme-snap #"+d+" > .content > .summary > div > .no-overflow"];a(g.join(",")).attr("data-ally-richcontent",f)}return c.resolve(),c.promise()},y=function(b,c,d){for(var e in b){var f=b[e],g=["body.path-mod-"+c+".cmid-"+e+" #intro > .no-overflow","li.activity.modtype_"+c+"#module-"+e+" .contentafterlink > .no-overflow > .no-overflow","li.snap-activity.modtype_"+c+"#module-"+e+" .contentafterlink > .no-overflow"];if(d)for(var h in d)g.push(d[h].replace("{{i}}",e));a(g.join(",")).attr("data-ally-richcontent",f)}},z=function(b){var c=b.intros;y(c,"forum");var d=b.posts;for(var e in d){var f="p"+e,g=d[e],h="#page-mod-forum-discuss a#"+f+" + div.firstpost div.posting.fullpost",i=h+" > *:not(.attachedimages):not([data-ally-richcontent])";a(h).prepend("<div data-ally-richcontent='"+g+"'></div>"),a(i).detach().appendTo(h+" > div[data-ally-richcontent]")}},A=function(b){var c=b.intros;y(c,"hsuforum",["#hsuforum-header .hsuforum_introduction > .no-overflow"]);var d=b.posts;for(var e in d){var f=d[e],g='article[id="p'+e+'"] div.posting';a(g).attr("data-ally-richcontent",f)}},B=function(b){var c=b.intros;y(c,"glossary");var d=b.entries;for(var e in d){var f=d[e],g=a('.entrylowersection .commands a[href*="id='+e+'"]'),h=a(g).parents(".glossarypost").find(".entry .no-overflow");a(h).attr("data-ally-richcontent",f)}},C=function(b){var c=b.intros;y(c,"page",["li.snap-native.modtype_page#module-{{i}} .contentafterlink > .summary-text"]);var d=b.content;for(var e in d){var f=d[e],g=["#page-mod-page-view #region-main .box.generalbox > .no-overflow","li.snap-native.modtype_page#module-"+e+" .pagemod-content"];a(g.join(",")).attr("data-ally-richcontent",f)}},D=function(b){var c=b.intros;y(c,"book",["li.snap-native.modtype_book#module-{{i}} .contentafterlink > .summary-text .no-overflow"]);var d=b.chapters;if(g.params.chapterid)f=g.params.chapterid;else var e=new URLSearchParams(window.location.search),f=e.get("chapterid");for(var h in d)if(f==h){var i=d[h],j=["#page-mod-book-view #region-main .box.generalbox.book_content > .no-overflow","li.snap-native.modtype_page#module-"+h+" .pagemod-content"];a(j.join(",")).attr("data-ally-richcontent",i)}},E=function(b){var d=b.intros;y(d,"lesson",["li.snap-native.modtype_lesson#module-{{i}} .contentafterlink > .summary-text .no-overflow"]);var e=b.lesson_pages;for(var f in e)if("page-mod-lesson-edit"===document.body.id){var j='//a[@id="lesson-'+f+'"]//ancestor::table//tbody/tr/td/div[contains(@class, "no-overflow")]',k=e[f],l=i(j);a(l).attr("data-ally-richcontent",k)}else{var l=i('//form[contains(@action, "continue.php")]//input[@name="pageid"]');if(l)var m=a(l).val();else var n=new URLSearchParams(window.location.search),m=n.get("pageid");if(m!=f)continue;var k=e[f],o=["#page-mod-lesson-view #region-main .box.contents > .no-overflow","#page-mod-lesson-view #region-main form > fieldset > .fcontainer > .contents .no-overflow","li.snap-native.modtype_page#module-"+f+" .pagemod-content"];a(o.join(",")).attr("data-ally-richcontent",k)}c.get_strings([{key:"answer",component:"mod_lesson"},{key:"response",component:"mod_lesson"}]).then(function(c){var d=c[0],e=c[1],f=b.lesson_answers,i=function(b,c,d,e){var f='//a[@id="lesson-'+b+'"]//ancestor::table//td/label[contains(text(),"'+d+" "+c+'")]/ancestor::tr/td[2]',g=h(f);for(var i in g){var j=g[i];a(j).attr("data-ally-richcontent",e)}};for(var j in f){var k=f[j],l=j.split("_"),m=l[0],n=l[1],o=l[2];if("page-mod-lesson-edit"===document.body.id)i(m,o,d,k);else{if(a('#page-mod-lesson-view label[for="id_answerid_'+n+'"]').attr("data-ally-richcontent",k),g.params.answerid&&g.params.answerid==n)a(".studentanswer tr:nth-of-type(1) > td div").attr("data-ally-richcontent",k);else{var p="answer_wrapper_"+n,q=a("#id_answerid_"+n);if(1!=q.data("annotated")){var r=q.nextAll();q.parent("label").append('<span id="answer_wrapper_'+n+'"></span>'),a("#"+p).append(r)}q.data("annotated",1)}a("#answer_wrapper_"+j).attr("data-ally-richcontent",k)}}var s=b.lesson_answers_response;for(var t in s){var k=s[t],l=t.split("_"),m=l[0],u=l[1],v=l[2];if("page-mod-lesson-edit"===document.body.id)i(m,v,e,k);else if(g.params.answerid&&g.params.answerid==u){var w="response_wrapper_"+u;if(!a(".studentanswer tr.lastrow > td #"+w).length){var r=a(".studentanswer tr.lastrow > td > br").nextAll();a(".studentanswer tr.lastrow > td > br").after('<span id="'+w+'"></span>'),a("#"+w).append(r)}a("#"+w).attr("data-ally-richcontent",k)}}})},F=function(b){var c=a.Deferred();return void 0!==b.mod_forum&&z(b.mod_forum),void 0!==b.mod_hsuforum&&A(b.mod_hsuforum),void 0!==b.mod_glossary&&B(b.mod_glossary),void 0!==b.mod_page&&C(b.mod_page),void 0!==b.mod_book&&D(b.mod_book),void 0!==b.mod_lesson&&E(b.mod_lesson),c.resolve(),c.promise()},G=function(b){var c=a.Deferred(),d=a("#snap-course-footer-summary > div.no-overflow");if(d.length){var e=w("course","course","summary",b.courseId);d.attr("data-ally-richcontent",e)}return c.resolve(),c.promise()},H=function(b){var c=a.Deferred(),d=b.block_html;for(var e in d){var f=d[e],g=["#inst"+e+".block_html > .card-body > .card-text > .no-overflow","#inst"+e+".block_html > .content > .no-overflow"],h=g.join(",");a(h).attr("data-ally-richcontent",f)}return c.resolve(),c.promise()},I=function(){M.util.js_pending("filter_ally_applyPlaceHolders");var b=a.Deferred();if(void 0===ally_module_maps||void 0===ally_section_maps)return b.resolve(),b.promise();var c=[{mapVar:ally_module_maps.file_resources,method:v},{mapVar:ally_module_maps.assignment_files,method:m},{mapVar:ally_module_maps.folder_files,method:n},{mapVar:ally_module_maps.forum_files,method:l},{mapVar:ally_module_maps.glossary_files,method:o},{mapVar:ally_module_maps.lesson_files,method:u},{mapVar:ally_section_maps,method:x},{mapVar:ally_annotation_maps,method:F},{mapVar:{courseId:g.courseId},method:G},{mapVar:ally_annotation_maps,method:H}];return a(document).ready(function(){var a=0,d=function(){a++,a===c.length&&(M.util.js_complete("filter_ally_applyPlaceHolders"),b.resolve())};for(var e in c){var f=c[e];Object.keys(f.mapVar).length>0?f.method(f.mapVar).done(d):d()}}),b.promise()},J=f.debounce(function(){return I()},1e3);this.initStageTwo=function(b,c){(g.canViewFeedback||g.canDownload)&&(J().done(function(){e.init(),d.init(b,c),setInterval(function(){n(ally_module_maps.folder_files)},5e3),g.initialised=!0}),a(document).ajaxComplete(function(){g.initialised&&J()}))},this.init=function(a,b,c,d,e,f){g.canViewFeedback=c,g.canDownload=d,g.courseId=e,g.params=f;var h=function(a){return M.cfg.wwwroot+"/pluginfile.php/"+M.cfg.contextid+"/filter_ally/"+a},i={};if(document.evaluate||(i["filter_ally/wgxpath"]=h("vendorjs/wgxpath.install")),"undefined"==typeof URLSearchParams&&(i["filter_ally/urlsearchparams"]=["https://cdnjs.cloudflare.com/ajax/libs/url-search-params/1.1.0/url-search-params.amd.js",h("vendorjs/url-search-params.amd")]),i!=={}){require.config({enforceDefine:!1,paths:i});var j=Object.keys(i);return void require(j,function(){"undefined"==typeof URLSearchParams&&(window.URLSearchParams=arguments[1]),g.initStageTwo(a,b)})}g.initStageTwo(a,b)}}});