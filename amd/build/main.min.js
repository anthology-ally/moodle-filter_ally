define(["jquery","core/templates","filter_ally/ally","filter_ally/imagecover","filter_ally/util"],function(a,b,c,d,e){return new function(){var f=this;f.canViewFeedback=!1,f.canDownload=!1;var g=function(c,d,e){var g=a.Deferred();return c.canviewfeedback=f.canViewFeedback,c.candownload=f.canDownload,c.html='<span id="content-target-'+d+'"></span>',b.render("filter_ally/wrapper",c).done(function(b){a(e).after(b),a("#content-target-"+d).after(e),a("#content-target-"+d).remove(),g.resolve()}),g.promise()},h=function(b,c){var d=a.Deferred(),f=0,h=a(b).length;return a(b).each(function(){var b,i,j=function(){f===h&&d.resolve()};"a"===a(this).prop("tagName").toLowerCase()?(b=a(this).attr("href"),i="a"):(b=a(this).attr("src"),i="img");var k;k=b.indexOf("?")>-1?/pluginfile.php\/(\d*)\/(.*)(\?)/:/pluginfile.php\/(\d*)\/(.*)/;var l,m=b.match(k);if(m){var n=m[1]+"/"+m[2];n=decodeURIComponent(n),l=c[n]}if(void 0===l){var o=e.getQuery(b);if(o.file){var p=decodeURIComponent(o.file);k=/\/(\d*)\/(.*)/,m=p.match(k),m&&(n=m[1]+"/"+m[2],n=decodeURIComponent(n),l=c[n])}}if(void 0===l)return f++,void j();var q={isimage:"img"===i,fileid:l,url:b};g(q,l,a(this)).done(function(){f++,j()})}),d.promise()},i=function(b){var c=a.Deferred();return h('.forumpost .attachedimages img[src*="pluginfile.php"]',b).done(function(){c.resolve()}),c.promise()},j=function(b){var c=a.Deferred();return e.whenTrue(function(){return a('div[id*="assign_files_tree"] .ygtvitem').length>0},10).done(function(){h('div[id*="assign_files_tree"] a[href*="pluginfile.php"]',b),c.resolve()}),c.promise()},k=function(b){var c=a.Deferred();return e.whenTrue(function(){return a(".foldertree > .filemanager .ygtvitem").length>0},10).done(function(){var a='.foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*="pluginfile.php"]';h(a,b).done(function(){c.resolve()})}),c.promise()},l=function(b){var c=a.Deferred();a(".entry .attachments > br").each(function(){var b=a(this).prev('a[href*="pluginfile.php"]');b.addClass("ally-glossary-attachment");var c=a(b).prev('a[href*="pluginfile.php"]');a(this).after('<div class="ally-glossary-attachment-row"></div>');var d=a(this).next(".ally-glossary-attachment-row");d.append(c),d.append(b),a(this).remove()});var d=".entry .attachments .ally-glossary-attachment";return h(d,b).done(function(){c.resolve()}),c.promise()},m=function(b){var c=a.Deferred(),d=0,e=function(){d++,d>=Object.keys(b).length&&c.resolve()};for(var f in b){var h=b[f];if(a("body").hasClass("theme-snap"))var i=a("#module-"+f+":not(.snap-native) .activityinstance .snap-asset-link a:first-of-type");else var i=a("#module-"+f+" .activityinstance a:first-of-type");var j=i.find(".filter-ally-wrapper");if(j.length>0)e();else{var k={isimage:!1,fileid:h,url:a(i).attr("href")};g(k,h,i).done(e)}}return c.promise()},n=function(){var b=a.Deferred();if(void 0===ally_module_maps)return b.resolve(),b.promise();var c=[{mapVar:ally_module_maps.file_resources,method:m},{mapVar:ally_module_maps.assignment_files,method:j},{mapVar:ally_module_maps.folder_files,method:k},{mapVar:ally_module_maps.forum_files,method:i},{mapVar:ally_module_maps.glossary_files,method:l}];return a(document).ready(function(){var a=0,d=function(){a++,a===c.length&&b.resolve()};for(var e in c){var f=c[e];Object.keys(f.mapVar).length>0?f.method(f.mapVar).done(d):d()}}),b.promise()};this.init=function(a,b,e,g){f.canViewFeedback=e,f.canDownload=g,(e||g)&&n().done(function(){d.init(),c.init(a,b),setInterval(function(){k(ally_module_maps.folder_files)},5e3)})}}});