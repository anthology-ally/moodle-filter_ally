define("filter_ally/main",["exports","jquery","core/templates","core/str","filter_ally/ally","filter_ally/imagecover","filter_ally/util","core_filters/events","core/log"],(function(_exports,_jquery,_templates,_str,_ally,_imagecover,_util,_events,_log){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_templates=_interopRequireDefault(_templates),_ally=_interopRequireDefault(_ally),_imagecover=_interopRequireDefault(_imagecover),_util=_interopRequireDefault(_util),_log=_interopRequireDefault(_log);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}const filterAllyMain=new class{constructor(){this.canViewFeedback=!1,this.canDownload=!1,this.initialised=!1,this.params={},this.observedNodes=new WeakSet,this.jwt=null,this.config=null,this.courseId=null,this.initTime=Date.now(),this.debouncedContentUpdateHandler=_util.default.debounce((async()=>{Date.now()-this.initTime>3e3&&(_log.default.debug("refreshing entity maps and reinitializing stage two"),await this.refreshEntityMaps(),this.initStageTwo())}),1e3),document.addEventListener(_events.eventTypes.filterContentUpdated,this.debouncedContentUpdateHandler)}getNodesByXpath(xpath){const result=window.document.createExpression(xpath).evaluate(window.document,XPathResult.ANY_TYPE),nodes=[];let node;do{node=result.iterateNext(),node&&nodes.push(node)}while(node);return nodes}getNodeByXpath(xpath){return window.document.createExpression(xpath).evaluate(window.document,XPathResult.FIRST_ORDERED_NODE_TYPE).singleNodeValue}renderTemplate(data,pathHash,targetEl){const dfd=_jquery.default.Deferred();return(0,_jquery.default)(targetEl).parents(".filter-ally-wrapper").length?(dfd.resolve(),dfd.promise()):(data.canviewfeedback=this.canViewFeedback,data.candownload=this.canDownload,data.html='<span id="content-target-'+pathHash+'"></span>',_templates.default.render("filter_ally/wrapper",data).done((function(result){0===(0,_jquery.default)(targetEl).next().find('span[data-file-id="'+pathHash+'"]').length&&((0,_jquery.default)(targetEl).after(result),(0,_jquery.default)("#content-target-"+pathHash).after(targetEl),(0,_jquery.default)("#content-target-"+pathHash).remove()),dfd.resolve()})),dfd.promise())}placeHoldSelector(selector,map){const dfd=_jquery.default.Deferred();let c=0;const length=(0,_jquery.default)(selector).length;return length?((0,_jquery.default)(selector).each(((_idx,el)=>{const checkComplete=()=>{c===length&&dfd.resolve()};let url,type;const element=(0,_jquery.default)(el);let regex;"a"===element.prop("tagName").toLowerCase()?(url=element.attr("href"),type="a"):(url=element.attr("src"),type="img"),regex=url.indexOf("?")>-1?/pluginfile.php\/(\d*)\/(.*)(\?)/:/pluginfile.php\/(\d*)\/(.*)/;const match=url.match(regex);let pathHash;if(match){let path=match[1]+"/"+match[2];path=decodeURIComponent(path),pathHash=map[path]}if(void 0===pathHash){const query=_util.default.getQuery(url);if(query.file){regex=/\/(\d*)\/(.*)/;const fileMatch=decodeURIComponent(query.file).match(regex);if(fileMatch){let path=fileMatch[1]+"/"+fileMatch[2];path=decodeURIComponent(path),pathHash=map[path]}}}if(void 0===pathHash)return c++,void checkComplete();const data={isimage:"img"===type,fileid:pathHash,url:url};this.renderTemplate(data,pathHash,element).done((()=>{c++,checkComplete()}))})),dfd.promise()):(dfd.resolve(),dfd.promise())}placeHoldForumModule(forumFileMapping){const dfd=_jquery.default.Deferred();return this.placeHoldSelector('.forumpost .attachedimages img[src*="pluginfile.php"], .forumpost .body-content-container a[href*="pluginfile.php"]',forumFileMapping).done((()=>{dfd.resolve()})),dfd.promise()}placeHoldAssignModule(assignFileMapping){const dfd=_jquery.default.Deferred();return _util.default.whenTrue((()=>(0,_jquery.default)('div[id*="assign_files_tree"] .ygtvitem').length>0),10).done((()=>{this.placeHoldSelector('div[id*="assign_files_tree"] a[href*="pluginfile.php"]',assignFileMapping),dfd.resolve()})),dfd.promise()}placeHoldFolderModule(folderFileMapping){const dfd=_jquery.default.Deferred();return _util.default.whenTrue((()=>(0,_jquery.default)(".foldertree > .filemanager .ygtvitem").length>0),10).done((()=>{this.placeHoldSelector('.foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*="pluginfile.php"]',folderFileMapping).done((()=>{dfd.resolve()}))})),dfd.promise()}placeHoldGlossaryModule(glossaryFileMapping){const dfd=_jquery.default.Deferred();(0,_jquery.default)(".entry .attachments > br").each((function(){const mainAnchor=(0,_jquery.default)(this).prev('a[href*="pluginfile.php"]');mainAnchor.addClass("ally-glossary-attachment");const iconAnchor=(0,_jquery.default)(mainAnchor).prev('a[href*="pluginfile.php"]');(0,_jquery.default)(this).after('<div class="ally-glossary-attachment-row"></div>');const container=(0,_jquery.default)(this).next(".ally-glossary-attachment-row");container.append(iconAnchor),container.append(mainAnchor),(0,_jquery.default)(this).remove()}));return this.placeHoldSelector(".entry .attachments .ally-glossary-attachment",glossaryFileMapping).done((()=>{dfd.resolve()})),dfd.promise()}urlEncodeFilePath(filePath){const parts=filePath.split("/");for(const p in parts)parts[p]=encodeURIComponent(parts[p]);return parts.join("/")}placeHoldLessonGeneral(map,selectorPrefix){const dfd=_jquery.default.Deferred();if(0===map.length)dfd.resolve();else for(const c in map){const path=this.urlEncodeFilePath(c),sel=selectorPrefix+'img[src*="'+path+'"], '+selectorPrefix+'a[href*="'+path+'"]';this.placeHoldSelector(sel,map).done((()=>{dfd.resolve()}))}return dfd.promise()}placeHoldLessonPageContents(pageContentsMap){return this.placeHoldLessonGeneral(pageContentsMap,"")}placeHoldLessonAnswersContent(pageAnswersMap){return this.placeHoldLessonGeneral(pageAnswersMap,".studentanswer table tr:nth-child(1) ")}placeHoldLessonResponsesContent(pageResponsesMap){return this.placeHoldLessonGeneral(pageResponsesMap,".studentanswer table tr.lastrow ")}placeHoldLessonModule(lessonFileMapping){const dfd=_jquery.default.Deferred(),pageContentsMap=lessonFileMapping.page_contents,pageAnswersMap=lessonFileMapping.page_answers,pageResponsesMap=lessonFileMapping.page_responses;return this.placeHoldLessonPageContents(pageContentsMap).then((()=>this.placeHoldLessonAnswersContent(pageAnswersMap))).then((()=>this.placeHoldLessonResponsesContent(pageResponsesMap))).then((()=>{dfd.resolve()})),dfd.promise()}placeHoldResourceModule(moduleFileMapping){const dfd=_jquery.default.Deferred();let c=0;const checkAllProcessed=()=>{c++,c>=Object.keys(moduleFileMapping).length&&dfd.resolve()};for(const moduleId in moduleFileMapping){const pathHash=moduleFileMapping[moduleId].content;let moduleEl;moduleEl=(0,_jquery.default)("body").hasClass("theme-snap")&&!(0,_jquery.default)("body").hasClass("format-tiles")?(0,_jquery.default)("#module-"+moduleId+":not(.snap-native) .activityinstance .snap-asset-link a:first-of-type:not(.clickable-region)"):(0,_jquery.default)("#module-"+moduleId+" .activity-instance a:first-of-type:not(.clickable-region,.editing_move)");if(moduleEl.find(".filter-ally-wrapper").length>0){checkAllProcessed();continue}const data={isimage:!1,fileid:pathHash,url:(0,_jquery.default)(moduleEl).attr("href")};this.renderTemplate(data,pathHash,moduleEl).done(checkAllProcessed)}return dfd.promise()}buildContentIdent(component,table,field,id){return[component,table,field,id].join(":")}annotateSections(sectionMapping){const dfd=_jquery.default.Deferred();for(const s in sectionMapping){const sectionId=sectionMapping[s],ident=this.buildContentIdent("course","course_sections","summary",sectionId),selectors=["#"+s+' > .content div[class*="summarytext"] .no-overflow',"#"+s+' > .section-item div[class*="summarytext"] .no-overflow',"body.theme-snap #"+s+" > .content > .summary > div > .no-overflow"];(0,_jquery.default)(selectors.join(",")).attr("data-ally-richcontent",ident)}return dfd.resolve(),dfd.promise()}annotateModuleIntros(introMapping,module,additionalSelectors){for(const i in introMapping){const annotation=introMapping[i],selectors=["body.path-mod-"+module+".cmid-"+i+" #intro > .no-overflow",this.config.moodleversion>=2023100900?"li.activity.modtype_"+module+"#module-"+i+" .activity-description .no-overflow > .no-overflow":"li.activity.modtype_"+module+"#module-"+i+" .description .no-overflow > .no-overflow","li.snap-activity.modtype_"+module+"#module-"+i+" .contentafterlink > .no-overflow"];if(additionalSelectors)for(const a in additionalSelectors)selectors.push(additionalSelectors[a].replace("{{i}}",i));(0,_jquery.default)(selectors.join(",")).attr("data-ally-richcontent",annotation)}}annotateForums(forumMapping){const intros=forumMapping.intros;this.annotateModuleIntros(intros,"forum");const discussions=forumMapping.posts;for(const d in discussions){const post="p"+d,annotation=discussions[d],selectors=["#page-mod-forum-discuss #"+post+" div.forumpost div.no-overflow"];(0,_jquery.default)(selectors.join(",")).attr("data-ally-richcontent",annotation)}}annotateMRForums(forumMapping){const intros=forumMapping.intros;this.annotateModuleIntros(intros,"hsuforum",["#hsuforum-header .hsuforum_introduction > .no-overflow"]);const discussions=forumMapping.posts;for(const d in discussions){const annotation=discussions[d],postSelector='article[id="p'+d+'"] div.posting';(0,_jquery.default)(postSelector).attr("data-ally-richcontent",annotation)}}annotateGlossary(mapping){const intros=mapping.intros;this.annotateModuleIntros(intros,"glossary");const entries=mapping.entries;for(const e in entries){const annotation=entries[e],entryFooter=(0,_jquery.default)('.entrylowersection .commands a[href*="id='+e+'"]'),entry=(0,_jquery.default)(entryFooter).parents(".glossarypost").find(".entry .no-overflow");(0,_jquery.default)(entry).attr("data-ally-richcontent",annotation)}}annotatePage(mapping){const intros=mapping.intros;this.annotateModuleIntros(intros,"page",["li.snap-native.modtype_page#module-{{i}} .contentafterlink > .summary-text"]);const content=mapping.content;for(const c in content){const annotation=content[c],selectors=["#page-mod-page-view.cmid-".concat(c," #region-main .box.generalbox > .no-overflow"),"li.snap-native.modtype_page#module-".concat(c," .pagemod-content")];(0,_jquery.default)(selectors.join(",")).attr("data-ally-richcontent",annotation)}}annotateBook(mapping){const intros=mapping.intros;this.annotateModuleIntros(intros,"book",["li.snap-native.modtype_book#module-{{i}} .contentafterlink > .summary-text .no-overflow"]);const content=mapping.chapters;let chapterId;if(this.params.chapterid)chapterId=this.params.chapterid;else{const urlParams=new URLSearchParams(window.location.search);chapterId=urlParams.get("chapterid")}_jquery.default.each(content,((ch,annotation)=>{if(chapterId!=ch)return;const selectors=["#page-mod-book-view #region-main .box.generalbox.book_content > .no-overflow","li.snap-native.modtype_page#module-"+ch+" .pagemod-content"];(0,_jquery.default)(selectors.join(",")).attr("data-ally-richcontent",annotation)}))}annotateLesson(mapping){const intros=mapping.intros;this.annotateModuleIntros(intros,"lesson",["li.snap-native.modtype_lesson#module-{{i}} .contentafterlink > .summary-text .no-overflow"]);const content=mapping.lesson_pages;for(const p in content)if("page-mod-lesson-edit"===document.body.id){const xpath='//a[@id="lesson-'+p+'"]//ancestor::table//tbody/tr/td/div[contains(@class, "no-overflow")]',annotation=content[p],node=this.getNodeByXpath(xpath);(0,_jquery.default)(node).attr("data-ally-richcontent",annotation)}else{const node=this.getNodeByXpath('//form[contains(@action, "continue.php")]//input[@name="pageid"]');let pageId;if(node)pageId=(0,_jquery.default)(node).val();else{pageId=new URLSearchParams(window.location.search).get("pageid")}if(pageId!=p)continue;const annotation=content[p],selectors=["#page-mod-lesson-view #region-main .box.contents > .no-overflow","#page-mod-lesson-view #region-main form > fieldset > .fcontainer > .contents .no-overflow","li.snap-native.modtype_page#module-"+p+" .pagemod-content"];(0,_jquery.default)(selectors.join(",")).attr("data-ally-richcontent",annotation)}(0,_str.get_strings)([{key:"answer",component:"mod_lesson"},{key:"response",component:"mod_lesson"}]).then((strings=>{const answerLabel=strings[0],responseLabel=strings[1],answers=mapping.lesson_answers,processAnswerResponse=(pageId,i,label,annotation)=>{const xpath='//a[@id="lesson-'+pageId+'"]//ancestor::table//td/label[contains(text(),"'+label+" "+i+'")]/ancestor::tr/td[2]',nodes=this.getNodesByXpath(xpath);for(const n in nodes){const node=nodes[n];(0,_jquery.default)(node).attr("data-ally-richcontent",annotation)}};for(const a in answers){const annotation=answers[a],tmpArr=a.split("_"),pageId=tmpArr[0],ansId=tmpArr[1],anum=tmpArr[2];if("page-mod-lesson-edit"===document.body.id)processAnswerResponse(pageId,anum,answerLabel,annotation);else{if((0,_jquery.default)('#page-mod-lesson-view label[for="id_answerid_'+ansId+'"]').attr("data-ally-richcontent",annotation),this.params.answerid&&this.params.answerid==ansId)(0,_jquery.default)(".studentanswer tr:nth-of-type(1) > td div").attr("data-ally-richcontent",annotation);else{const answerWrapperId="answer_wrapper_"+ansId,answerEl=(0,_jquery.default)("#id_answerid_"+ansId);if(1!=answerEl.data("annotated")){const contentEls=answerEl.nextAll();answerEl.parent("label").append('<span id="answer_wrapper_'+ansId+'"></span>'),(0,_jquery.default)("#"+answerWrapperId).append(contentEls)}answerEl.data("annotated",1)}(0,_jquery.default)("#answer_wrapper_"+a).attr("data-ally-richcontent",annotation)}}const responses=mapping.lesson_answers_response;for(const r in responses){const annotation=responses[r],tmpArr=r.split("_"),pageId=tmpArr[0],respId=tmpArr[1],rnum=tmpArr[2];if("page-mod-lesson-edit"===document.body.id)processAnswerResponse(pageId,rnum,responseLabel,annotation);else if(this.params.answerid&&this.params.answerid==respId){const responseWrapperId="response_wrapper_"+respId;if(!(0,_jquery.default)(".studentanswer tr.lastrow > td #"+responseWrapperId).length){const contentEls=(0,_jquery.default)(".studentanswer tr.lastrow > td > br").nextAll();(0,_jquery.default)(".studentanswer tr.lastrow > td > br").after('<span id="'+responseWrapperId+'"></span>'),(0,_jquery.default)("#"+responseWrapperId).append(contentEls)}(0,_jquery.default)("#"+responseWrapperId).attr("data-ally-richcontent",annotation)}}}))}annotateModules(moduleMapping){const dfd=_jquery.default.Deferred();return void 0!==moduleMapping.mod_forum&&this.annotateForums(moduleMapping.mod_forum),void 0!==moduleMapping.mod_hsuforum&&this.annotateMRForums(moduleMapping.mod_hsuforum),void 0!==moduleMapping.mod_glossary&&this.annotateGlossary(moduleMapping.mod_glossary),void 0!==moduleMapping.mod_page&&this.annotatePage(moduleMapping.mod_page),void 0!==moduleMapping.mod_book&&this.annotateBook(moduleMapping.mod_book),void 0!==moduleMapping.mod_lesson&&this.annotateLesson(moduleMapping.mod_lesson),dfd.resolve(),dfd.promise()}annotateSnapCourseSummary(mapping){const dfd=_jquery.default.Deferred(),snapFooterCourseSummary=(0,_jquery.default)("#snap-course-footer-summary > div.no-overflow");if(snapFooterCourseSummary.length){const ident=this.buildContentIdent("course","course","summary",mapping.courseId);snapFooterCourseSummary.attr("data-ally-richcontent",ident)}return dfd.resolve(),dfd.promise()}annotateHtmlBlock(mapping){const dfd=_jquery.default.Deferred(),items=mapping.block_html;for(const i in items){const ident=items[i],selector=["#inst"+i+".block_html > .card-body > .card-text > .no-overflow","#inst"+i+".block_html > .content > .no-overflow"].join(",");(0,_jquery.default)(selector).attr("data-ally-richcontent",ident)}return dfd.resolve(),dfd.promise()}applyPlaceHolders(){M.util.js_pending("filter_ally_applyPlaceHolders");const dfd=_jquery.default.Deferred();if(void 0===ally_module_maps||void 0===ally_section_maps)return dfd.resolve(),dfd.promise();const tasks=[{mapVar:ally_module_maps.file_resources,method:this.placeHoldResourceModule.bind(this)},{mapVar:ally_module_maps.assignment_files,method:this.placeHoldAssignModule.bind(this)},{mapVar:ally_module_maps.folder_files,method:this.placeHoldFolderModule.bind(this)},{mapVar:ally_module_maps.forum_files,method:this.placeHoldForumModule.bind(this)},{mapVar:ally_module_maps.glossary_files,method:this.placeHoldGlossaryModule.bind(this)},{mapVar:ally_module_maps.lesson_files,method:this.placeHoldLessonModule.bind(this)},{mapVar:ally_section_maps,method:this.annotateSections.bind(this)},{mapVar:ally_annotation_maps,method:this.annotateModules.bind(this)},{mapVar:{courseId:this.courseId},method:this.annotateSnapCourseSummary.bind(this)},{mapVar:ally_annotation_maps,method:this.annotateHtmlBlock.bind(this)}];return(0,_jquery.default)(document).ready((()=>{let completed=0;const onTaskComplete=()=>{completed++,completed===tasks.length&&(M.util.js_complete("filter_ally_applyPlaceHolders"),dfd.resolve())};for(const t in tasks){const task=tasks[t];Object.keys(task.mapVar).length>0?task.method(task.mapVar).done(onTaskComplete):onTaskComplete()}})),dfd.promise()}async refreshEntityMaps(){if(this.courseId)try{const Ajax=await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["core/ajax"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("core/ajax")):Promise.resolve(_systemImportTransformerGlobalIdentifier["core/ajax"])),response=await Ajax.call([{methodname:"filter_ally_get_module_maps",args:{courseid:this.courseId}}]),result=await response[0];if(result.success){const moduleData={};result.modulemaps.forEach((map=>{moduleData[map.maptype]=JSON.parse(map.mapdata)})),window.ally_module_maps=moduleData;const sectionData={};result.sectionmaps.forEach((map=>{sectionData[map.sectionkey]=map.sectionid})),window.ally_section_maps=sectionData,window.ally_annotation_maps=JSON.parse(result.annotationmaps),_log.default.debug("Entity maps refreshed successfully")}else _log.default.error("Failed to refresh entity maps:",result)}catch(error){_log.default.error("Error refreshing entity maps:",error)}else _log.default.warn("Course ID not available for refreshing entity maps")}initStageTwo(){const{jwt:jwt,config:config}=this;(this.canViewFeedback||this.canDownload)&&(this.debounceApplyPlaceHolders().done((()=>{_imagecover.default.init(),_ally.default.init(jwt,config);try{const targetNode=(0,_jquery.default)(".foldertree > .filemanager")[0];if(targetNode){const observerConfig={attributes:!0,childList:!0,subtree:!0},observer=new MutationObserver((mutationsList=>{mutationsList.filter((mutation=>"childList"===mutation.type)).forEach((()=>{this.placeHoldFolderModule(ally_module_maps.folder_files)}))}));this.observedNodes.has(targetNode)||(observer.observe(targetNode,observerConfig),this.observedNodes.add(targetNode))}}catch(error){setInterval((()=>{this.placeHoldFolderModule(ally_module_maps.folder_files)}),5e3)}this.initialised=!0})),(0,_jquery.default)(document).ajaxComplete((()=>{this.initialised&&this.debounceApplyPlaceHolders()})),(0,_jquery.default)("body.theme-snap").length&&(0,_jquery.default)(document).ajaxComplete(((event,xhr,settings)=>{settings.url.includes("ally.js")&&(setTimeout((()=>{(0,_jquery.default)(".ally-feedback.ally-active.ally-score-indicator-embedded span").each((function(){"none"==this.style.display&&(this.style.display="block","ally-scoreindicator-container"==this.getAttribute("class")&&(this.style.display="inline-block",this.children[0].style.display="inline-block"))}))}),5e3),(0,_jquery.default)(document).off("ajaxComplete"))})))}init(jwt,config,canViewFeedback,canDownload,courseId,params){this.canViewFeedback=canViewFeedback,this.canDownload=canDownload,this.courseId=courseId,this.params=params,this.jwt=jwt,this.config=config;const pluginJSURL=path=>M.cfg.wwwroot+"/pluginfile.php/"+M.cfg.contextid+"/filter_ally/"+path,polyfills={};if(document.evaluate||(polyfills["filter_ally/wgxpath"]=pluginJSURL("vendorjs/wgxpath.install")),"undefined"==typeof URLSearchParams&&(polyfills["filter_ally/urlsearchparams"]=["https://cdnjs.cloudflare.com/ajax/libs/url-search-params/1.1.0/url-search-params.amd.js",pluginJSURL("vendorjs/url-search-params.amd")]),Object.keys(polyfills).length>0){require.config({enforceDefine:!1,paths:polyfills});const requires=Object.keys(polyfills);require(requires,(()=>{"undefined"==typeof URLSearchParams&&(window.URLSearchParams=arguments[1]),this.initStageTwo()}))}else this.initStageTwo()}get debounceApplyPlaceHolders(){return this._debounceApplyPlaceHolders||(this._debounceApplyPlaceHolders=_util.default.debounce((()=>this.applyPlaceHolders()),1e3)),this._debounceApplyPlaceHolders}};var _default=filterAllyMain;return _exports.default=_default,_exports.default}));

//# sourceMappingURL=main.min.js.map