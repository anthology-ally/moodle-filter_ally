define(["jquery","core/templates","filter_ally/ally","filter_ally/imagecover","filter_ally/util"],function(a,b,c,d,e){return new function(){var f=this;f.canViewFeedback=!1,f.canDownload=!1,f.initialised=!1,f.params={};var g=function(c,d,e){var g=a.Deferred();return a(e).parents(".filter-ally-wrapper").length?(g.resolve(),g.promise()):(c.canviewfeedback=f.canViewFeedback,c.candownload=f.canDownload,c.html='<span id="content-target-'+d+'"></span>',b.render("filter_ally/wrapper",c).done(function(b){a(e).after(b),a("#content-target-"+d).after(e),a("#content-target-"+d).remove(),g.resolve()}),g.promise())},h=function(b,c){var d=a.Deferred(),f=0,h=a(b).length;return a(b).each(function(){var b,i,j=function(){f===h&&d.resolve()};"a"===a(this).prop("tagName").toLowerCase()?(b=a(this).attr("href"),i="a"):(b=a(this).attr("src"),i="img");var k;k=b.indexOf("?")>-1?/pluginfile.php\/(\d*)\/(.*)(\?)/:/pluginfile.php\/(\d*)\/(.*)/;var l,m=b.match(k);if(m){var n=m[1]+"/"+m[2];n=decodeURIComponent(n),l=c[n]}if(void 0===l){var o=e.getQuery(b);if(o.file){var p=decodeURIComponent(o.file);k=/\/(\d*)\/(.*)/,m=p.match(k),m&&(n=m[1]+"/"+m[2],n=decodeURIComponent(n),l=c[n])}}if(void 0===l)return f++,void j();var q={isimage:"img"===i,fileid:l,url:b};g(q,l,a(this)).done(function(){f++,j()})}),d.promise()},i=function(b){var c=a.Deferred();return h('.forumpost .attachedimages img[src*="pluginfile.php"]',b).done(function(){c.resolve()}),c.promise()},j=function(b){var c=a.Deferred();return e.whenTrue(function(){return a('div[id*="assign_files_tree"] .ygtvitem').length>0},10).done(function(){h('div[id*="assign_files_tree"] a[href*="pluginfile.php"]',b),c.resolve()}),c.promise()},k=function(b){var c=a.Deferred();return e.whenTrue(function(){return a(".foldertree > .filemanager .ygtvitem").length>0},10).done(function(){var a='.foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*="pluginfile.php"]';h(a,b).done(function(){c.resolve()})}),c.promise()},l=function(b){var c=a.Deferred();a(".entry .attachments > br").each(function(){var b=a(this).prev('a[href*="pluginfile.php"]');b.addClass("ally-glossary-attachment");var c=a(b).prev('a[href*="pluginfile.php"]');a(this).after('<div class="ally-glossary-attachment-row"></div>');var d=a(this).next(".ally-glossary-attachment-row");d.append(c),d.append(b),a(this).remove()});var d=".entry .attachments .ally-glossary-attachment";return h(d,b).done(function(){c.resolve()}),c.promise()},m=function(a){var b=a.split("/");for(var c in b)b[c]=encodeURIComponent(b[c]);var d=b.join("/");return d},n=function(b,c){var d=a.Deferred();for(var e in b){var f=m(e),g=c+'img[src*="'+f+'"], '+c+'a[href*="'+f+'"]';h(g,b).done(function(){d.resolve()})}return d.promise()},o=function(a){return n(a,"")},p=function(a){return n(a,".studentanswer table tr:nth-child(1) ")},q=function(a){return n(a,".studentanswer table tr.lastrow ")},r=function(b){var c=a.Deferred(),d=b.page_contents,e=b.page_answers,f=b.page_responses;return o(d).then(function(){return p(e)}).then(function(){return q(f)}).then(function(){c.resolve()}),c.promise()},s=function(b){var c=a.Deferred(),d=0,e=function(){d++,d>=Object.keys(b).length&&c.resolve()};for(var f in b){var h=b[f].content;if(a("body").hasClass("theme-snap"))var i=a("#module-"+f+":not(.snap-native) .activityinstance .snap-asset-link a:first-of-type");else var i=a("#module-"+f+" .activityinstance a:first-of-type");var j=i.find(".filter-ally-wrapper");if(j.length>0)e();else{var k={isimage:!1,fileid:h,url:a(i).attr("href")};g(k,h,i).done(e)}}return c.promise()},t=function(a,b,c,d){return[a,b,c,d].join(":")},u=function(b){var c=a.Deferred();for(var d in b){var e=b[d],f=t("course","course_sections","summary",e),g=["#"+d+' > .content > div[class*="summary"] > .no-overflow',"body.theme-snap #"+d+" > .content > .summary > div > .no-overflow"];a(g.join(",")).attr("data-ally-richcontent",f)}return c.resolve(),c.promise()},v=function(b,c,d){for(var e in b){var f=b[e],g=["body.path-mod-"+c+".cmid-"+e+" #intro > .no-overflow","li.activity.modtype_"+c+"#module-"+e+" .contentafterlink > .no-overflow > .no-overflow","li.snap-activity.modtype_"+c+"#module-"+e+" .contentafterlink > .no-overflow"];if(d)for(var h in d)g.push(d[h].replace("{{i}}",e));a(g.join(",")).attr("data-ally-richcontent",f)}},w=function(b){var c=b.intros;v(c,"forum");var d=b.posts;for(var e in d){var f="p"+e,g=d[e],h="#page-mod-forum-discuss a#"+f+" + div.firstpost div.posting.fullpost",i=h+" > *:not(.attachedimages):not([data-ally-richcontent])";a(h).prepend("<div data-ally-richcontent='"+g+"'></div>"),a(i).detach().appendTo(h+" > div[data-ally-richcontent]")}},x=function(b){var c=b.intros;v(c,"hsuforum",["#hsuforum-header .hsuforum_introduction > .no-overflow"]);var d=b.posts;for(var e in d){var f=d[e],g='article[id="p'+e+'"] div.posting';a(g).attr("data-ally-richcontent",f)}},y=function(b){var c=b.intros;v(c,"glossary");var d=b.entries;for(var e in d){var f=d[e],g=a('.entrylowersection .commands a[href*="id='+e+'"]'),h=a(g).parents(".glossarypost").find(".entry .no-overflow");a(h).attr("data-ally-richcontent",f)}},z=function(b){var c=b.intros;v(c,"page",["li.snap-native.modtype_page#module-{{i}} .contentafterlink > .summary-text"]);var d=b.content;for(var e in d){var f=d[e],g=["#page-mod-page-view #region-main .box.generalbox > .no-overflow","li.snap-native.modtype_page#module-"+e+" .pagemod-content"];a(g.join(",")).attr("data-ally-richcontent",f)}},A=function(b){var c=b.intros;v(c,"book",["li.snap-native.modtype_book#module-{{i}} .contentafterlink > .summary-text .no-overflow"]);var d=b.chapters;for(var e in d){var f=new URLSearchParams(window.location.search),g=f.get("chapterid");if(g==e){var h=d[e],i=["#page-mod-book-view #region-main .box.generalbox.book_content > .no-overflow","li.snap-native.modtype_page#module-"+e+" .pagemod-content"];a(i.join(",")).attr("data-ally-richcontent",h)}}},B=function(b){var c=b.intros;v(c,"lesson",["li.snap-native.modtype_lesson#module-{{i}} .contentafterlink > .summary-text .no-overflow"]);var d=b.lesson_pages;for(var e in d){var g=new URLSearchParams(window.location.search),h=g.get("pageid");if(h==e){var i=d[e],j=["#page-mod-lesson-view #region-main .box.contents > .no-overflow","#page-mod-lesson-view #region-main form > fieldset > .fcontainer > .contents .no-overflow","li.snap-native.modtype_page#module-"+e+" .pagemod-content"];a(j.join(",")).attr("data-ally-richcontent",i)}}var k=b.lesson_answers;for(var l in k){var i=k[l];if(f.params.answerid&&f.params.answerid==l)a(".studentanswer tr:nth-of-type(1) > td div").attr("data-ally-richcontent",i);else{var m="answer_wrapper_"+l,n=a("#id_answerid_"+l);if(1==n.data("annotated")){var o=n.nextAll();n.parent("label").append('<span id="answer_wrapper_'+l+'"></span>'),a("#"+m).append(o)}n.data("annotated",1)}a("#answer_wrapper_"+l).attr("data-ally-richcontent",i)}var p=b.lesson_answers_response;for(var q in p)if(f.params.answerid&&f.params.answerid==q){var i=p[q],r="response_wrapper_"+q;if(!a(".studentanswer tr.lastrow > td #"+r).length){var o=a(".studentanswer tr.lastrow > td > br").nextAll();a(".studentanswer tr.lastrow > td > br").after('<span id="'+r+'"></span>'),a("#"+r).append(o)}a("#"+r).attr("data-ally-richcontent",i)}},C=function(b){var c=a.Deferred();return void 0!==b.mod_forum&&w(b.mod_forum),void 0!==b.mod_hsuforum&&x(b.mod_hsuforum),void 0!==b.mod_glossary&&y(b.mod_glossary),void 0!==b.mod_page&&z(b.mod_page),void 0!==b.mod_book&&A(b.mod_book),void 0!==b.mod_lesson&&B(b.mod_lesson),c.resolve(),c.promise()},D=function(b){var c=a.Deferred(),d=a("#snap-course-footer-summary > div.no-overflow");if(d.length){var e=t("course","course","summary",b.courseId);d.attr("data-ally-richcontent",e)}return c.resolve(),c.promise()},E=function(){var b=a.Deferred();if(void 0===ally_module_maps||void 0===ally_section_maps)return b.resolve(),b.promise();var c=[{mapVar:ally_module_maps.file_resources,method:s},{mapVar:ally_module_maps.assignment_files,method:j},{mapVar:ally_module_maps.folder_files,method:k},{mapVar:ally_module_maps.forum_files,method:i},{mapVar:ally_module_maps.glossary_files,method:l},{mapVar:ally_module_maps.lesson_files,method:r},{mapVar:ally_section_maps,method:u},{mapVar:ally_annotation_maps,method:C},{mapVar:{courseId:f.courseId},method:D}];return a(document).ready(function(){var a=0,d=function(){a++,a===c.length&&b.resolve()};for(var e in c){var f=c[e];Object.keys(f.mapVar).length>0?f.method(f.mapVar).done(d):d()}}),b.promise()},F=e.debounce(function(){return E()},1e3);this.init=function(b,e,g,h,i,j){f.canViewFeedback=g,f.canDownload=h,f.courseId=i,f.params=j,(g||h)&&(F().done(function(){d.init(),c.init(b,e),setInterval(function(){k(ally_module_maps.folder_files)},5e3),f.initialised=!0}),a(document).ajaxComplete(function(){f.initialised&&F()}))}}});