define ("filter_ally/main",["jquery","core/templates","core/str","filter_ally/ally","filter_ally/imagecover","filter_ally/util"],function(b,a,c,d,e,f){return new function(){var g=this;g.canViewFeedback=!1;g.canDownload=!1;g.initialised=!1;g.params={};var h=function(a){var b=window.document.createExpression(a),c=b.evaluate(window.document,XPathResult.ANY_TYPE),d=[];do{var e=c.iterateNext();d.push(e)}while(e);return d},i=function(a){var b=window.document.createExpression(a),c=b.evaluate(window.document,XPathResult.FIRST_ORDERED_NODE_TYPE);return c.singleNodeValue},j=function(c,d,e){var f=b.Deferred();if(b(e).parents(".filter-ally-wrapper").length){f.resolve();return f.promise()}c.canviewfeedback=g.canViewFeedback;c.candownload=g.canDownload;c.html="<span id=\"content-target-"+d+"\"></span>";a.render("filter_ally/wrapper",c).done(function(a){var c=b(e).next().find("span[data-file-id=\""+d+"\"]");if(0==c.length){b(e).after(a);b("#content-target-"+d).after(e);b("#content-target-"+d).remove()}f.resolve()});return f.promise()},k=function(a,d){var e=b.Deferred(),g=0,h=b(a).length;if(!h){e.resolve()}b(a).each(function(){var a=function(){if(g===h){e.resolve()}},c,i;if("a"===b(this).prop("tagName").toLowerCase()){c=b(this).attr("href");i="a"}else{c=b(this).attr("src");i="img"}var k;if(-1<c.indexOf("?")){k=/pluginfile.php\/(\d*)\/(.*)(\?)/}else{k=/pluginfile.php\/(\d*)\/(.*)/}var l=c.match(k),m;if(l){var n=l[1]+"/"+l[2];n=decodeURIComponent(n);m=d[n]}if(m===void 0){var o=f.getQuery(c);if(o.file){var p=decodeURIComponent(o.file);k=/\/(\d*)\/(.*)/;l=p.match(k);if(l){n=l[1]+"/"+l[2];n=decodeURIComponent(n);m=d[n]}}}if(m===void 0){g++;a();return}var q={isimage:"img"===i,fileid:m,url:c};j(q,m,b(this)).done(function(){g++;a()})});return e.promise()},l=function(a){var c=b.Deferred();k(".forumpost .attachedimages img[src*=\"pluginfile.php\"], .forumpost .body-content-container a[href*=\"pluginfile.php\"]",a).done(function(){c.resolve()});return c.promise()},m=function(a){var c=b.Deferred();f.whenTrue(function(){return 0<b("div[id*=\"assign_files_tree\"] .ygtvitem").length},10).done(function(){k("div[id*=\"assign_files_tree\"] a[href*=\"pluginfile.php\"]",a);c.resolve()});return c.promise()},n=function(a){var c=b.Deferred();f.whenTrue(function(){return 0<b(".foldertree > .filemanager .ygtvitem").length},10).done(function(){k(".foldertree > .filemanager span:not(.filter-ally-wrapper) > a[href*=\"pluginfile.php\"]",a).done(function(){c.resolve()})});return c.promise()},o=function(a){var c=b.Deferred();b(".entry .attachments > br").each(function(){var a=b(this).prev("a[href*=\"pluginfile.php\"]");a.addClass("ally-glossary-attachment");var c=b(a).prev("a[href*=\"pluginfile.php\"]");b(this).after("<div class=\"ally-glossary-attachment-row\"></div>");var d=b(this).next(".ally-glossary-attachment-row");d.append(c);d.append(a);b(this).remove()});k(".entry .attachments .ally-glossary-attachment",a).done(function(){c.resolve()});return c.promise()},p=function(a){var b=a.split("/");for(var c in b){b[c]=encodeURIComponent(b[c])}var d=b.join("/");return d},q=function(a,d){var e=b.Deferred();if(0===a.length){e.resolve()}else{for(var f in a){var c=p(f);k(d+"img[src*=\""+c+"\"], "+d+"a[href*=\""+c+"\"]",a).done(function(){e.resolve()})}}return e.promise()},r=function(a){return q(a,"")},s=function(a){return q(a,".studentanswer table tr:nth-child(1) ")},t=function(a){return q(a,".studentanswer table tr.lastrow ")},u=function(a){var c=b.Deferred(),d=a.page_contents,e=a.page_answers,f=a.page_responses;r(d).then(function(){return s(e)}).then(function(){return t(f)}).then(function(){c.resolve()});return c.promise()},v=function(a){var d=b.Deferred(),e=0,f=function(){e++;if(e>=Object.keys(a).length){d.resolve()}};for(var g in a){var h=a[g].content;if(b("body").hasClass("theme-snap")){var i=b("#module-"+g+":not(.snap-native) .activityinstance .snap-asset-link a:first-of-type")}else{var i=b("#module-"+g+" .activityinstance a:first-of-type")}var k=i.find(".filter-ally-wrapper");if(0<k.length){f();continue}var l={isimage:!1,fileid:h,url:b(i).attr("href")};j(l,h,i).done(f)}return d.promise()},w=function(a,b,c,d){return[a,b,c,d].join(":")},x=function(a){var c=b.Deferred();for(var d in a){var e=a[d],f=w("course","course_sections","summary",e);b(["#"+d+" > .content div[class*=\"summary\"] > .no-overflow","body.theme-snap #"+d+" > .content > .summary > div > .no-overflow"].join(",")).attr("data-ally-richcontent",f)}c.resolve();return c.promise()},y=function(c,d,e){for(var f in c){var g=c[f],h=["body.path-mod-"+d+".cmid-"+f+" #intro > .no-overflow","li.activity.modtype_"+d+"#module-"+f+" .contentafterlink > .no-overflow > .no-overflow","li.snap-activity.modtype_"+d+"#module-"+f+" .contentafterlink > .no-overflow"];if(e){for(var i in e){h.push(e[i].replace("{{i}}",f))}}b(h.join(",")).attr("data-ally-richcontent",g)}},z=function(a){var c=a.intros;y(c,"forum");var e=a.posts;for(var f in e){var d=e[f],g="#page-mod-forum-discuss a#"+("p"+f)+" + div.firstpost div.posting.fullpost";b(g).prepend("<div data-ally-richcontent='"+d+"'></div>");b(g+" > *:not(.attachedimages):not([data-ally-richcontent])").detach().appendTo(g+" > div[data-ally-richcontent]")}},A=function(a){var c=a.intros;y(c,"hsuforum",["#hsuforum-header .hsuforum_introduction > .no-overflow"]);var e=a.posts;for(var f in e){var d=e[f];b("article[id=\"p"+f+"\"] div.posting").attr("data-ally-richcontent",d)}},B=function(a){var c=a.intros;y(c,"glossary");var d=a.entries;for(var f in d){var e=d[f],g=b(".entrylowersection .commands a[href*=\"id="+f+"\"]"),h=b(g).parents(".glossarypost").find(".entry .no-overflow");b(h).attr("data-ally-richcontent",e)}},C=function(a){var d=a.intros;y(d,"page",["li.snap-native.modtype_page#module-{{i}} .contentafterlink > .summary-text"]);var e=a.content;for(var f in e){var c=e[f];b(["#page-mod-page-view #region-main .box.generalbox > .no-overflow","li.snap-native.modtype_page#module-"+f+" .pagemod-content"].join(",")).attr("data-ally-richcontent",c)}},D=function(a){var c=a.intros;y(c,"book",["li.snap-native.modtype_book#module-{{i}} .contentafterlink > .summary-text .no-overflow"]);var d=a.chapters,e;if(g.params.chapterid){e=g.params.chapterid}else{var f=new URLSearchParams(window.location.search);e=f.get("chapterid")}b.each(d,function(a,c){if(e!=a){return}b(["#page-mod-book-view #region-main .box.generalbox.book_content > .no-overflow","li.snap-native.modtype_page#module-"+a+" .pagemod-content"].join(",")).attr("data-ally-richcontent",c)})},E=function(d){var e=d.intros;y(e,"lesson",["li.snap-native.modtype_lesson#module-{{i}} .contentafterlink > .summary-text .no-overflow"]);var f=d.lesson_pages;for(var j in f){if("page-mod-lesson-edit"===document.body.id){var a=f[j],k=i("//a[@id=\"lesson-"+j+"\"]//ancestor::table//tbody/tr/td/div[contains(@class, \"no-overflow\")]");b(k).attr("data-ally-richcontent",a)}else{var k=i("//form[contains(@action, \"continue.php\")]//input[@name=\"pageid\"]");if(k){var l=b(k).val()}else{var m=new URLSearchParams(window.location.search),l=m.get("pageid")}if(l!=j){continue}var a=f[j];b(["#page-mod-lesson-view #region-main .box.contents > .no-overflow","#page-mod-lesson-view #region-main form > fieldset > .fcontainer > .contents .no-overflow","li.snap-native.modtype_page#module-"+j+" .pagemod-content"].join(",")).attr("data-ally-richcontent",a)}}c.get_strings([{key:"answer",component:"mod_lesson"},{key:"response",component:"mod_lesson"}]).then(function(c){var e=c[0],f=c[1],i=d.lesson_answers,j=function(a,c,d,e){var f=h("//a[@id=\"lesson-"+a+"\"]//ancestor::table//td/label[contains(text(),\""+d+" "+c+"\")]/ancestor::tr/td[2]");for(var g in f){var i=f[g];b(i).attr("data-ally-richcontent",e)}};for(var k in i){var a=i[k],l=k.split("_"),m=l[0],n=l[1],o=l[2];if("page-mod-lesson-edit"===document.body.id){j(m,o,e,a)}else{b("#page-mod-lesson-view label[for=\"id_answerid_"+n+"\"]").attr("data-ally-richcontent",a);if(g.params.answerid&&g.params.answerid==n){b(".studentanswer tr:nth-of-type(1) > td div").attr("data-ally-richcontent",a)}else{var p=b("#id_answerid_"+n);if(1!=p.data("annotated")){var q=p.nextAll();p.parent("label").append("<span id=\"answer_wrapper_"+n+"\"></span>");b("#"+("answer_wrapper_"+n)).append(q)}p.data("annotated",1)}b("#answer_wrapper_"+k).attr("data-ally-richcontent",a)}}var s=d.lesson_answers_response;for(var t in s){var a=s[t],l=t.split("_"),m=l[0],r=l[1],u=l[2];if("page-mod-lesson-edit"===document.body.id){j(m,u,f,a)}else if(g.params.answerid&&g.params.answerid==r){var v="response_wrapper_"+r;if(!b(".studentanswer tr.lastrow > td #"+v).length){var q=b(".studentanswer tr.lastrow > td > br").nextAll();b(".studentanswer tr.lastrow > td > br").after("<span id=\""+v+"\"></span>");b("#"+v).append(q)}b("#"+v).attr("data-ally-richcontent",a)}}})},F=function(a){var c=b.Deferred();if(a.mod_forum!==void 0){z(a.mod_forum)}if(a.mod_hsuforum!==void 0){A(a.mod_hsuforum)}if(a.mod_glossary!==void 0){B(a.mod_glossary)}if(a.mod_page!==void 0){C(a.mod_page)}if(a.mod_book!==void 0){D(a.mod_book)}if(a.mod_lesson!==void 0){E(a.mod_lesson)}c.resolve();return c.promise()},G=function(a){var c=b.Deferred(),d=b("#snap-course-footer-summary > div.no-overflow");if(d.length){var e=w("course","course","summary",a.courseId);d.attr("data-ally-richcontent",e)}c.resolve();return c.promise()},H=function(a){var c=b.Deferred(),d=a.block_html;for(var e in d){var f=d[e],g=["#inst"+e+".block_html > .card-body > .card-text > .no-overflow","#inst"+e+".block_html > .content > .no-overflow"].join(",");b(g).attr("data-ally-richcontent",f)}c.resolve();return c.promise()},I=function(){M.util.js_pending("filter_ally_applyPlaceHolders");var a=b.Deferred();if(ally_module_maps===void 0||ally_section_maps===void 0){a.resolve();return a.promise()}var c=[{mapVar:ally_module_maps.file_resources,method:v},{mapVar:ally_module_maps.assignment_files,method:m},{mapVar:ally_module_maps.folder_files,method:n},{mapVar:ally_module_maps.forum_files,method:l},{mapVar:ally_module_maps.glossary_files,method:o},{mapVar:ally_module_maps.lesson_files,method:u},{mapVar:ally_section_maps,method:x},{mapVar:ally_annotation_maps,method:F},{mapVar:{courseId:g.courseId},method:G},{mapVar:ally_annotation_maps,method:H}];b(document).ready(function(){var b=0,d=function(){b++;if(b===c.length){M.util.js_complete("filter_ally_applyPlaceHolders");a.resolve()}};for(var e in c){var f=c[e];if(0<Object.keys(f.mapVar).length){f.method(f.mapVar).done(d)}else{d()}}});return a.promise()},J=f.debounce(function(){return I()},1e3);this.initStageTwo=function(a,c){if(g.canViewFeedback||g.canDownload){J().done(function(){e.init();d.init(a,c);try{var f=b(".foldertree > .filemanager"),h=f[0];if(h){var i=function(a){a.filter(function(a){return"childList"===a.type}).forEach(function(){n(ally_module_maps.folder_files)})},j=new MutationObserver(i);j.observe(h,{attributes:!0,childList:!0,subtree:!0})}}catch(a){setInterval(function(){n(ally_module_maps.folder_files)},5e3)}g.initialised=!0});b(document).ajaxComplete(function(){if(!g.initialised){return}J()})}};this.init=function(a,b,c,d,e,f){g.canViewFeedback=c;g.canDownload=d;g.courseId=e;g.params=f;var h=function(a){return M.cfg.wwwroot+"/pluginfile.php/"+M.cfg.contextid+"/filter_ally/"+a},i={};if(!document.evaluate){i["filter_ally/wgxpath"]=h("vendorjs/wgxpath.install")}if("undefined"==typeof URLSearchParams){i["filter_ally/urlsearchparams"]=["https://cdnjs.cloudflare.com/ajax/libs/url-search-params/1.1.0/url-search-params.amd.js",h("vendorjs/url-search-params.amd")]}if({}!==i){require.config({enforceDefine:!1,paths:i});var j=Object.keys(i);require(j,function(){if("undefined"==typeof URLSearchParams){window.URLSearchParams=arguments[1]}g.initStageTwo(a,b)});return}g.initStageTwo(a,b)}}});
//# sourceMappingURL=main.min.js.map
